<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ASIM-SAE — Aplicación de soporte para la inscripción de migrantes</title>
<style>
:root{
  --sae-green:#007A33;
  --muted:#6b6b6b;
  --card-bg:#fff;
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Arial;
}
html,body{height:100%;margin:0;background:#f5f5f5;  display: flex;  flex-direction: column;}
.container {  flex: 1; /* ocupa todo el espacio disponible entre header y footer */
  display: flex;
  flex-direction: column;
}
header {position: relative;display:flex;align-items:center;gap:12px;padding:8px 20px;justify-content: space-between;} /* separa los logos a los lados */
header .logo-izquierda{height:60px; object-fit: contain;flex-shrink: 0;}
header .logo-derecha{height:75px; object-fit: contain;flex-shrink: 0;}
header h1{margin:0;color:var(--sae-green);font-size:30px}
header h2{margin:0;font-size:19px;color:var(--muted)}
header .titulo-header {position: absolute;text-align: center;flex: 1;left: 50%;transform: translateX(-50%);white-space: nowrap;}    
.search-container { display:flex; flex-direction:column; align-items:center; margin: 15px auto; width:100%; max-width:950px; background:white; padding:15px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.search-container2 { display:flex; flex-direction:column; align-items:center; margin: 15px auto; width:100%; max-width:950px; background:white; padding:15px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.search-intro { text-align:center; width:100%; margin-bottom:8px; font-size:17px; color:#222; }
.filters { display:flex; gap:18px; width:100%; justify-content: center; flex-wrap:wrap; margin-bottom:14px; }
.filters label { display:flex; align-items:center; gap:8px; font-size:0.95rem; color:#222; }
.filters input[type="checkbox"]{ width:16px; height:16px; }
#searchArea{ width:100%; display:flex; flex-direction:column; gap:10px }
.search-top{ display:flex; gap:10px; align-items:center }
.search-top input{ flex:1; padding:12px 14px; border-radius:8px; border:1px solid #dfeee0; font-size:16px }
.search-top button{ padding:11px 18px; border-radius:8px; border:none; background:var(--sae-green); color:#fff; font-weight:600; cursor:pointer }
.search-top button[disabled]{ opacity:0.5; cursor:not-allowed }
.search-meta{ display:flex; justify-content:space-between; color:var(--muted); font-size:13px; }
.results{ margin-top:8px }
.result-item{ display:flex; gap:12px; padding:10px; border-radius:8px; border:1px solid #e6efe7; background:#fff; margin-bottom:8px; cursor:pointer }
.result-item h3{ margin:0;font-size:15px }
.result-item p{ margin:6px 0 0;color:var(--muted);font-size:13px }
.modal-backdrop{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:9999 }
.modal{ background:var(--card-bg); border-radius:10px; padding:0; width:90%; max-width:720px; max-height:80vh; overflow:auto; box-shadow:0 20px 40px rgba(0,0,0,0.25) }
.modal-header-sae{ background:var(--sae-green); color:#fff; padding:14px 18px; border-top-left-radius:10px; border-top-right-radius:10px }
.modal-body-sae{ padding:16px 18px; line-height:1.8;   /* interlineado mayor */ }
.actions{ display:flex; gap:10px; justify-content:center; padding:12px }  
.actions button{ padding:11px 18px; border-radius:8px; border:none; background:var(--sae-green); color:#fff; font-weight:600; cursor:pointer }
.no-data{ color:var(--muted); font-style:italic }
@media (max-width:600px){ .filters{flex-direction:column;align-items:flex-start} }
footer {
  display: flex;
  justify-content: space-between; /* uno a la izquierda, otro a la derecha */
  align-items: center;           /* centrado vertical */
  padding: 10px 20px;
  background-color: #f5f5f5;
  flex-wrap: wrap;               /* opcional: que se adapten en pantallas pequeñas */
}

.footer-logo, .footer-datos {
  font-size: 13px;
  color:var(--muted);  
}
.footer-logo .logo-text {
  left: 0;}
  
.results .small {
  color: #1b5e20;
  font-size: 15px;
  margin-bottom: 6px;
}
#doc ul {
  margin: 8px 0 0 20px;   /* separación y sangría */
  padding: 0;
  list-style-type: disc;  /* tipo de viñeta: disc, circle, square */
}

#doc li {
  margin-bottom: 6px;     /* espacio entre elementos */
  font-size: 15px;
  color: #333;
}
.results .result-item p {
  white-space: pre-wrap; /* mantiene saltos de línea */
}
.search-input-wrapper {
  position: relative;
  width: 100%;
}

#searchInput {
  width: 100%;
  padding-right: 32px; /* espacio para la cruz */
  height: 36px;
  font-size: 14px;
  box-sizing: border-box;
  /* background: #94EB9D;*/
}

#searchInput {
  background-color: #e0e0e0;  /* color cuando está deshabilitado */
  transition: background-color 0.3s ease;
}

#searchInput.enabled {
  background-color: #d7f5d1; /* color cuando se desbloquea */
}
  

.clear-btn-wrapper {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
}

.clear-icon {
  width: 16px;
  height: 16px;
  stroke: black;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  background: none;
  pointer-events: none;
}
  
</style>
</head>
<body>
<div class="container">
  <header>
    <img class="logo-izquierda" src="images/SAE_Junta_de_Andalucia_Documentacion.png" alt="Logo Junta de Andalucía">
    <div class="titulo-header">
      <h1>ASIM-SAE</h1>
      <h2>Aplicación de soporte para la inscripción de migrantes</h2>
    </div>
    <img class="logo-derecha" src="images/Logo_SILA_Migrantes.png" alt="Logo proyecto">
  </header>
  
  <div id="doc" class="search-container">
    <p><strong>Documentación necesaria para la inscripción de una persona extranjera:</strong></p>
    <ul>
      <li>Identificación de la persona usuaria: documentación expedida por España con foto (Tarjeta TIE, Resolución con Foto, Pasaporte).</li>
      <li>Tarjeta TIE o Resolución en Vigor.</li>
      <li>Solicitud (sólo en los casos habilitados).</li>
    </ul>
  </div>

  <div class="search-container2" role="region" aria-labelledby="intro">  
    <div id="intro" class="search-intro">
      <p><strong>Consulta SILA y marca lo que corresponda:</strong></p>
    </div>

    <div class="filters" aria-label="Opciones SILA">
      <label><input type="checkbox" id="chkInscrito"> Consta una inscripción previa en SILA</label>
      <label><input type="checkbox" id="chkPrestacion"> Cobra prestación o subsidio</label>
      <label><input type="checkbox" id="chkNada"> Inscripción Inicial</label>
    </div>

  <div id="searchArea" class="search-area" aria-live="polite">
    <div class="search-top">
      <div class="search-input-wrapper">
        <input id="searchInput" type="text" placeholder="Introduce la denominación de la autorización o solicitud a buscar…" aria-label="Introduce el texto a buscar">
        <span class="clear-btn-wrapper" id="clearSearchInline">
          <svg class="clear-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </span>
      </div>
      <button id="btnSearch" class="btn btn-nocomunitario">Buscar</button>
    </div>
    <div class="search-meta">
      <!-- <span class="small">Filtros SILA marcados: <span id="inscritoEstado" class="small no-data">no definido</span></span>-->
      <span class="small">Resultados: <span id="countResults">0</span></span>
    </div>
    <div class="results" id="results" aria-live="polite"></div>
  </div>

  <div id="modalDetalle" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header-sae"><h3 id="modalDetalleTitulo">Datos para la Inscripción</h3></div>
      <div class="modal-body-sae" id="modalDetalleContent"></div>
      <div class="actions">
        <button id="btnVolverDetalle" class="btn">Volver</button>
      </div>
    </div>
  </div>
</div>  

</div>
  <footer>
    <div class="footer-logo">
      <div class="logo-text"><b>Versión 6.21 — Dirección Provincial de Granada</b> </div>
    </div>
    <div class="footer-datos">
      <b>Apoyo durante la fase de testeo, para la resolución de dudas y la recogida de incidencias:</b><br>
      <hr>
      Elisabeth Huertas García &lt;<a href="mailto:elisabeth.huertas.garcia@juntadeandalucia.es">elisabeth.huertas.garcia@juntadeandalucia.es</a>&gt; – 765145<br>
      José Manuel Robles Chaves &lt;<a href="mailto:josem.robles@juntadeandalucia.es">josem.robles@juntadeandalucia.es</a>&gt; – 653467
    </div>
  </footer>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Elementos ---
  const chkInscrito = document.getElementById('chkInscrito');
  const chkPrestacion = document.getElementById('chkPrestacion');
  const chkNada = document.getElementById('chkNada');
  const estadoChecks = document.getElementById('inscritoEstado');

  const searchInput = document.getElementById('searchInput');
  const btnSearch = document.getElementById('btnSearch');
  const resultsEl = document.getElementById('results');
  const countResults = document.getElementById('countResults');
  const clearBtn = document.getElementById('clearSearch');

  const modalDetalle = document.getElementById('modalDetalle');
  const modalDetalleContent = document.getElementById('modalDetalleContent');
  const btnVolverDetalle = document.getElementById('btnVolverDetalle');

  const clearSearchInline = document.getElementById('clearSearchInline');
  if (clearSearchInline) {
    clearSearchInline.addEventListener('click', () => {
      searchInput.value = '';
      resultsEl.innerHTML = '';
      countResults.textContent = '0';
      searchInput.focus();
    });
  }

  let db = [];
  let userInscritoAnswer = null;

  // --- Utilidades ---
  function getField(obj, possibleNames){
    const keys = Object.keys(obj);
    for(const n of possibleNames){
      const normN = n.trim().toLowerCase();
      for(const key of keys){
        if(key.trim().toLowerCase() === normN) return obj[key];
      }
    }
    return undefined;
  }

  function normalize(s){
    if(!s) return '';
    return String(s)
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .replace(/[^\p{L}\p{N}]+/gu,' ')
      .toLowerCase()
      .trim();
  }

  const STOPWORDS = new Set(['a','la','el','los','las','de','del','y','o','en','por','para','con','sin','que','un','una','al','se','su','sus']);

  function tokenizeQuery(q) {
    const norm = normalize(q);
    if (!norm) return [];
    const toks = Array.from(new Set(norm.split(/\s+/).filter(Boolean)));
    const filtered = toks.filter(t => !STOPWORDS.has(t));

    // “no autoriza”
    const merged = [];
    for (let i = 0; i < filtered.length; i++) {
      if (filtered[i] === 'no' && filtered[i + 1] === 'autoriza') {
        merged.push('no autoriza');
        i++;
      } else {
        merged.push(filtered[i]);
      }
    }
    return merged.length > 0 ? merged : filtered;
  }

  // --- MODAL DETALLE ----------------------------------------------------------------------
function openModalDetalle(rec){
  // limpiar contenido previo
  modalDetalleContent.innerHTML = '';

  // helper
  function valueOf(names){
    const v = getField(rec, names);
    return (v === undefined || v === null) ? '' : String(v).trim();
  }

  // campos a mostrar
  const fields = [
    { label: 'Inscripción en SILA', names: ['Inscripción en SILA','Inscripcion en SILA'] },
    { label: 'Tipo de Demanda', names: ['Tipo de Demanda','Tipo demanda'] },
    { label: 'Autoriza a Trabajar', names: ['Autoriza a Trabajar','Autoriza a Trabajar'] },
    { label: 'Observaciones', names: ['Observaciones','OBSERVACIONES'], boldTitle: true }
  ];

  let anyField = false;

  fields.forEach(f => {
    const val = valueOf(f.names);
    if(val){
      anyField = true;
      const row = document.createElement('div');
      row.className = 'field';

      // título
      const strongTitle = document.createElement(f.boldTitle ? 'strong' : 'span');
      strongTitle.textContent = f.label + ': ';
      row.appendChild(strongTitle);

      // valor en negrita (menos Observaciones)
      const valueElement = document.createElement(f.boldTitle ? 'span' : 'strong');
      valueElement.textContent = val;

      row.appendChild(valueElement);
      modalDetalleContent.appendChild(row);
    }
  });

  // Documentación
  const docVal = valueOf(['Documentación','Documentacion','DOCUMENTACIÓN']);
  if(docVal){
    anyField = true;

    const row = document.createElement('div');
    row.className = 'field';

    const title = document.createElement('span');
    title.textContent = 'Documentación: ';
    row.appendChild(title);

    // valor en negrita si no es Observaciones
    const valStrong = document.createElement('strong');

    // enlace si parece URL
    if(/^https?:\/\//i.test(docVal) || docVal.includes('/') || /\.(pdf|docx?|xlsx?)$/i.test(docVal)) {
      const a = document.createElement('a');
      a.href = docVal;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = 'Ver documento';
      valStrong.appendChild(a);
    } else {
      valStrong.textContent = docVal;
    }

    row.appendChild(valStrong);
    modalDetalleContent.appendChild(row);
  }

  if(!anyField){
    const none = document.createElement('div');
    none.className = 'small';
    none.textContent = 'No hay datos para mostrar en este registro.';
    modalDetalleContent.appendChild(none);
  }

  modalDetalle.style.display = 'flex';
  modalDetalle.setAttribute('aria-hidden','false');
}




  function closeModalDetalle(){
    modalDetalle.style.display='none';
    modalDetalle.setAttribute('aria-hidden','true');
  }

  btnVolverDetalle.addEventListener('click', closeModalDetalle);

  // --- Carga JSON ---
  async function loadJSON(){
    try{
      const res = await fetch('./SituacionesAdministrativas.json', {cache:'no-store'});
      if(!res.ok) throw new Error('No se pudo cargar SituacionesAdministrativas.json');
      db = await res.json();
      console.log('Registros cargados:', db.length);
    }catch(err){
      resultsEl.innerHTML =
        `<div class="small" style="color:#c62828">Error al cargar JSON: ${err.message}</div>`;
    }
  }
  loadJSON();

  // --- Filtros SILA ---
  function syncNadaLogic(changed){
    if(changed==='nada' && chkNada.checked){
      chkInscrito.checked=false;
      chkPrestacion.checked=false;
    }
    if((changed==='inscrito'||changed==='prestacion') &&
       (chkInscrito.checked||chkPrestacion.checked)){
      chkNada.checked=false;
    }
  }

  function actualizarChecks(){
    syncNadaLogic();

    const activos=[];
    if(chkInscrito.checked){
      //activos.push('Consta inscripción previa en SILA');
      userInscritoAnswer='SI';
    }else{
      userInscritoAnswer=null;
    }
    //if(chkPrestacion.checked) {userPrestacionAnswer='SI';//activos.push('Cobra prestación o subsidio');}
   // if(chkNada.checked) activos.push('Inscripción Inicial');

    if(activos.length>0){
      estadoChecks.textContent=activos.join(', ');
      estadoChecks.classList.remove('no-data');
      searchInput.disabled=false;
      btnSearch.disabled=false;
      resultsEl.innerHTML='';
      countResults.textContent='0';
    } else {
      estadoChecks.textContent='ninguna';
      estadoChecks.classList.add('no-data');
      searchInput.disabled=true;
      btnSearch.disabled=true;
      searchInput.value='';
      resultsEl.innerHTML='';
      countResults.textContent='0';
    }
  }

  chkInscrito.addEventListener('change', ()=>{ syncNadaLogic('inscrito'); actualizarChecks(); });
  chkPrestacion.addEventListener('change', ()=>{ syncNadaLogic('prestacion'); actualizarChecks(); });
  chkNada.addEventListener('change', ()=>{ syncNadaLogic('nada'); actualizarChecks(); });

  actualizarChecks();

  // --- Botón limpiar ---
  if(clearBtn){
    searchInput.addEventListener('input', ()=>{ clearBtn.style.display = searchInput.value ? 'block' : 'none'; });
    clearBtn.addEventListener('click', ()=>{
      searchInput.value='';
      clearBtn.style.display='none';
      searchInput.focus();
      resultsEl.innerHTML='';
      countResults.textContent='0';
    });
  }

  // Normalizador exacto de tokens
  function containsTokenExact(recordText, token) {
    const text = normalize(recordText); 
    const words = text.split(/\s+/);
    token = token.toLowerCase();

    if(token === 'autoriza'){
      for(let i=0;i<words.length;i++){
        if(words[i] === 'autoriza'){
          if(i===0 || words[i-1] !== 'no') return true;
        }
      }
      return false;
    } else if(token === 'no autoriza'){
      for(let i=0;i<words.length-1;i++){
        if(words[i]==='no' && words[i+1]==='autoriza') return true;
      }
      return false;
    } else {
      return words.includes(token);
    }
  }

  // --- Búsqueda ---
  function doSearch(){
    resultsEl.innerHTML='';
    const q = searchInput.value.trim();
    if(!q){
      resultsEl.innerHTML='<div class="small">Escribe una o varias palabras para buscar.</div>';
      countResults.textContent='0';
      return;
    }

    const tokens = tokenizeQuery(q);
    if(tokens.length===0){
      resultsEl.innerHTML='<div class="small">Escribe una o varias palabras para buscar.</div>';
      countResults.textContent='0';
      return;
    }

    const matches=[];

    db.forEach((rec, idx)=>{
      const valInscritoAnterior = getField(rec, ['¿Inscrito anteriormente?','Inscrito anteriormente','INSCRITO ANTERIORMENTE','inscrito anteriormente']);
      const valNorm = valInscritoAnterior ? String(valInscritoAnterior).trim().toUpperCase() : '';
      const includeByInscrito =
        valNorm === '' || (userInscritoAnswer && valNorm === userInscritoAnswer);
      if(!includeByInscrito) return;

      const anverso = normalize(getField(rec, ['ANVERSO','Anverso','anverso'])||'');
      const reverso = normalize(getField(rec, ['REVERSO','Reverso','reverso'])||'');
      const combined = `${anverso} ${reverso}`;

      let presentCount=0;
      tokens.forEach(tok=>{
        if(containsTokenExact(combined, tok)) presentCount++;
      });

      if(tokens.length>0 && (presentCount/tokens.length) >= 0.75){
        matches.push({rec, idx});
      }
    });

    if(matches.length===0){
      resultsEl.innerHTML='<div class="small">No se han encontrado registros con el filtro aplicado.</div>';
      countResults.textContent='0';
      return;
    }

    countResults.textContent = String(matches.length);

    matches.forEach(m=>{
      const rec = m.rec;

      const wrapper = document.createElement('div');
      wrapper.className='result-item';
      wrapper.style.cursor='pointer';

      const chkWrap = document.createElement('div');
      chkWrap.className='check';
      const chk = document.createElement('input');
      chk.type='checkbox';
      chk.name='selectRec';
      chk.dataset.index=m.idx;
      chkWrap.appendChild(chk);

      const content = document.createElement('div');
      content.style.flex='1';
      const title = document.createElement('h3');
      title.textContent = getField(rec, ['Mostrar', 'mostrar']) || 'Registro sin campo Mostrar';
      const p = document.createElement('p');
      p.textContent = '';
      content.appendChild(title);
      content.appendChild(p);

      wrapper.appendChild(chkWrap);
      wrapper.appendChild(content);

      wrapper.addEventListener('click', (e)=>{
        if(e.target.tagName.toLowerCase() === 'input') return;
        const all = Array.from(document.querySelectorAll('input[name="selectRec"]'));
        all.forEach(inp=> inp.checked=false );
        chk.checked = true;
        openModalDetalle(rec);
      });

      chk.addEventListener('change', (e)=>{
        const all = Array.from(document.querySelectorAll('input[name="selectRec"]'));
        all.forEach(inp=>{ if(inp!==e.target) inp.checked=false; });
        if(!e.target.checked) return;
        openModalDetalle(rec);
      });

      resultsEl.appendChild(wrapper);
    });
  }

  btnSearch.addEventListener('click', doSearch);
  searchInput.addEventListener('keydown', e=>{
    if(e.key==='Enter') doSearch();
  });

});
</script>


</body>
</html>
