<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ASIM-SAE — Aplicación de soporte para la inscripción de migrantes</title>
<style>
:root{
  --sae-green:#007A33;
  --muted:#6b6b6b;
  --card-bg:#fff;
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Arial;
}
html,body{height:100%;margin:0;background:#f5f5f5;  display: flex;  flex-direction: column;}
.container {  flex: 1; /* ocupa todo el espacio disponible entre header y footer */
  display: flex;
  flex-direction: column;
}
header {position: relative;display:flex;align-items:center;gap:12px;padding:8px 20px;justify-content: space-between;} /* separa los logos a los lados */
header .logo-izquierda{height:60px; object-fit: contain;flex-shrink: 0;}
header .logo-derecha{height:75px; object-fit: contain;flex-shrink: 0;}
header h1{margin:0;color:var(--sae-green);font-size:30px}
header h2{margin:0;font-size:19px;color:var(--muted)}
header .titulo-header {position: absolute;text-align: center;flex: 1;left: 50%;transform: translateX(-50%);white-space: nowrap;}    
.search-container { display:flex; flex-direction:column; align-items:center; margin: 15px auto; width:100%; max-width:950px; background:white; padding:15px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.search-container2 { display:flex; flex-direction:column; align-items:center; margin: 15px auto; width:100%; max-width:950px; background:white; padding:15px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.search-intro { text-align:center; width:100%; margin-bottom:8px; font-size:17px; color:#222; }
.filters { display:flex; gap:18px; width:100%; justify-content: center; flex-wrap:wrap; margin-bottom:14px; }
.filters label { display:flex; align-items:center; gap:8px; font-size:0.95rem; color:#222; }
.filters input[type="checkbox"]{ width:16px; height:16px; }
#searchArea{ width:100%; display:flex; flex-direction:column; gap:10px }
.search-top{ display:flex; gap:10px; align-items:center }
.search-top input{ flex:1; padding:12px 14px; border-radius:8px; border:1px solid #dfeee0; font-size:16px }
.search-top button{ padding:11px 18px; border-radius:8px; border:none; background:var(--sae-green); color:#fff; font-weight:600; cursor:pointer }
.search-top button[disabled]{ opacity:0.5; cursor:not-allowed }
.search-meta{ display:flex; justify-content:space-between; color:var(--muted); font-size:13px; }
.results{ margin-top:8px }
.result-item{ display:flex; gap:12px; padding:10px; border-radius:8px; border:1px solid #e6efe7; background:#fff; margin-bottom:8px; cursor:pointer }
.result-item h3{ margin:0;font-size:15px }
.result-item p{ margin:6px 0 0;color:var(--muted);font-size:13px }
.modal-backdrop{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:9999 }
.modal{ background:var(--card-bg); border-radius:10px; padding:0; width:90%; max-width:720px; max-height:80vh; overflow:auto; box-shadow:0 20px 40px rgba(0,0,0,0.25) }
.modal-header-sae{ background:var(--sae-green); color:#fff; padding:14px 18px; border-top-left-radius:10px; border-top-right-radius:10px }
.modal-body-sae{ padding:16px 18px; line-height:1.8;   /* interlineado mayor */ }
.actions{ display:flex; gap:10px; justify-content:center; padding:12px }  
.actions button{ padding:11px 18px; border-radius:8px; border:none; background:var(--sae-green); color:#fff; font-weight:600; cursor:pointer }
.no-data{ color:var(--muted); font-style:italic }
@media (max-width:600px){ .filters{flex-direction:column;align-items:flex-start} }
footer {
  display: flex;
  justify-content: space-between; /* uno a la izquierda, otro a la derecha */
  align-items: center;           /* centrado vertical */
  padding: 10px 20px;
  background-color: #f5f5f5;
  flex-wrap: wrap;               /* opcional: que se adapten en pantallas pequeñas */
}

.footer-logo, .footer-datos {
  font-size: 13px;
  color:var(--muted);  
}
.footer-logo .logo-text {
  left: 0;}
  
.results .small {
  color: #1b5e20;
  font-size: 15px;
  margin-bottom: 6px;
}
#doc ul {
  margin: 8px 0 0 20px;   /* separación y sangría */
  padding: 0;
  list-style-type: disc;  /* tipo de viñeta: disc, circle, square */
}

#doc li {
  margin-bottom: 6px;     /* espacio entre elementos */
  font-size: 15px;
  color: #333;
}
.results .result-item p {
  white-space: pre-wrap; /* mantiene saltos de línea */
}
.search-input-wrapper {
  position: relative;
  width: 100%;
}

#searchInput {
  width: 100%;
  padding-right: 32px; /* espacio para la cruz */
  height: 36px;
  font-size: 14px;
  box-sizing: border-box;
  /* background: #94EB9D;*/
}

#searchInput {
  background-color: #72D677;  /* color cuando está deshabilitado */
  transition: background-color 0.3s ease;
  color: #757575;
}

#searchInput.enabled {
  background-color: #E9FFE5;  /* color cuando está habilitado */
  color: #000;
}
/* Estilo del placeholder cuando está deshabilitado */
#searchInput:disabled::placeholder {
  color: #757575;  /* gris suave */
}

/* Ocultar placeholder cuando está habilitado */
#searchInput.enabled::placeholder {
  color: transparent;
}
  

.clear-btn-wrapper {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
}

.clear-icon {
  width: 16px;
  height: 16px;
  stroke: black;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  background: none;
  pointer-events: none;
}
/* Animación suave al activarse el campo */
@keyframes inputFlash {
  0%   { background-color: #d8f5d2; }   /* verde clarito */
  100% { background-color: white; }
}

input.enabled.flash {
  animation: inputFlash 0.4s ease-out;
}
.result-item h4 {
  font-weight: normal;
}

</style>
</head>
<body>
  <!-- Diseño e idea original de la Dirección Provincial de Granada, en concreto de:
  Jefe de Servicio: Francisco Escabias García.
  Diseñador: Valentín Jiménez Extremera.
  Contenido: Elisabeth Huertas García y José Manuel Robles Chaves.
  Testeo y verificación: Isabel Peláez Carmona, Silvia Gómez Martín, Inmaculada Ortega Avilés, Beatriz Girela Muñoz.
  Aporte de información: Todas las oficinas SAE de la provincia de Granada y sus direcciones de ATE.
  JSON actualizado a 04/12/2025 9:33 horas -->  
<div class="container">
  <header>
    <img class="logo-izquierda" src="images/SAE_Junta_de_Andalucia_Documentacion.png" alt="Logo Junta de Andalucía">
    <div class="titulo-header">
      <h1>ASIM-SAE</h1>
      <h2>Aplicación de soporte para la inscripción de migrantes</h2>
    </div>
    <img class="logo-derecha" src="images/Logo_SILA_Migrantes2_corto.png" alt="Logo proyecto">
  </header>
  
  <div id="doc" class="search-container">
    <p><strong>Documentación necesaria para la inscripción de una persona extranjera:</strong></p>
    <ul>
      <li>Identificación de la persona usuaria: documentación expedida por España con foto (Tarjeta TIE, Resolución con Foto, Pasaporte).</li>
      <li>Tarjeta TIE o Resolución en Vigor.</li>
      <li>Solicitud (sólo en los casos habilitados).</li>
    </ul>
  </div>

  <div class="search-container2" role="region" aria-labelledby="intro">  
    <div id="intro" class="search-intro">
      <p><strong>Consulta SILA y marca lo que corresponda:</strong></p>
    </div>

    <div class="filters" aria-label="Opciones SILA">
      <label><input type="checkbox" id="chkInscrito"> Consta una inscripción previa en SILA</label>
      <label><input type="checkbox" id="chkPrestacion"> Cobra prestación o subsidio</label>
      <label><input type="checkbox" id="chkNada"> Inscripción Inicial</label>
    </div>

  <div id="searchArea" class="search-area" aria-live="polite">
    <div class="search-top">
      <div class="search-input-wrapper">
        <input id="searchInput" type="text" placeholder="Introduce la denominación de la autorización o solicitud a buscar…" aria-label="Introduce el texto a buscar" disabled>
        <span class="clear-btn-wrapper" id="clearSearchInline">
          <svg class="clear-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </span>
      </div>
      <button id="btnSearch" class="btn btn-nocomunitario">Buscar</button>
    </div>
    <div class="search-meta">
      <!-- <span class="small">Filtros SILA marcados: <span id="inscritoEstado" class="small no-data">no definido</span></span>-->
      <span class="small">Resultados: <span id="countResults">0</span></span>
    </div>
    <div class="results" id="results" aria-live="polite"></div>
    <div class="results" aria-live="polite" style="color:var(--muted);font-size:13px;text-align: center;" >La información ofrecida con esta herramienta es meramente orientativa y pretende ser un apoyo a la inscripción de las personas migrantes en SILA.<br> <u>En ningún caso puede sustituir al sistema de resolución de incidencias establecido vía SAEclick.</u></div>
  </div>

  <div id="modalDetalle" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header-sae">Datos para la Inscripción:<h3 id="modalDetalleTitulo"></h3></div>
      <div class="modal-body-sae" id="modalDetalleContent"></div>
      <div class="actions">
        <button id="btnVolverDetalle" class="btn">Volver</button>
      </div>
    </div>
  </div>
  <div id="modalPreguntas" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header-sae">
        <h3 id="modalPreguntasTitulo" style="margin:6px 0 0"></h3>
        <hr>
        <div>Indica la información que se solicita</div>
      </div>
  
      <div class="modal-body-sae" id="modalPreguntasContent"></div>
  
      <div class="actions">
        <button id="btnCancelarPreguntas" class="btn">Cancelar</button>
        <button id="btnContinuarPreguntas" class="btn">Continuar</button>
      </div>
    </div>
  </div>
    
</div>  

</div>
  <footer>
    <div class="footer-logo">
      <div class="logo-text"><b>Versión pruebas — Dirección Provincial de Granada</b> </div>
    </div>
    <div class="footer-datos">
      <b>Apoyo durante la fase de testeo, para la resolución de dudas y la recogida de incidencias:</b><br>
      <hr>
      Elisabeth Huertas García &lt;<a href="mailto:elisabeth.huertas.garcia@juntadeandalucia.es">elisabeth.huertas.garcia@juntadeandalucia.es</a>&gt; – 765145<br>
      José Manuel Robles Chaves &lt;<a href="mailto:josem.robles@juntadeandalucia.es">josem.robles@juntadeandalucia.es</a>&gt; – 653467
    </div>
  </footer>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Elementos ---
  const chkInscrito = document.getElementById('chkInscrito');
  const chkPrestacion = document.getElementById('chkPrestacion');
  const chkNada = document.getElementById('chkNada');
  const estadoChecks = document.getElementById('inscritoEstado');

  const searchInput = document.getElementById('searchInput');
  const btnSearch = document.getElementById('btnSearch');
  const resultsEl = document.getElementById('results');
  const countResults = document.getElementById('countResults');

  const modalDetalle = document.getElementById('modalDetalle');  
  const modalDetalleTitulo = document.getElementById('modalDetalleTitulo');
  const modalDetalleContent = document.getElementById('modalDetalleContent');
  const btnVolverDetalle = document.getElementById('btnVolverDetalle');
  
  const modalPreguntas = document.getElementById('modalPreguntas');
  const modalPreguntasTitulo = document.getElementById('modalPreguntasTitulo');
  const modalPreguntasContent = document.getElementById('modalPreguntasContent');
  const btnCancelarPreguntas = document.getElementById('btnCancelarPreguntas');
  const btnContinuarPreguntas = document.getElementById('btnContinuarPreguntas');
  
  const clearSearchInline = document.getElementById('clearSearchInline');
  if (clearSearchInline) {
    clearSearchInline.addEventListener('click', () => {
      searchInput.value = '';
      resultsEl.innerHTML = '';
      countResults.textContent = '0';
      searchInput.focus();
    });
  }

  let db = [];
  let userInscritoAnswer = null;

  // --- Utilidades ---
  function getField(obj, possibleNames){
    if (!obj) return undefined; // proteger por si obj es null/undefined
    const keys = Object.keys(obj);
    for(const n of possibleNames){
      const normN = n.trim().toLowerCase();
      for(const key of keys){
        if(key.trim().toLowerCase() === normN) return obj[key];
      }
    }
    return undefined;
  }

// --- MODAL DETALLE ----------------------------------------------------------------------
// ✅ convierte **texto** a <strong>texto</strong>
function renderBoldMarkdown(text){
  if(!text) return '';
  return String(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}

// --- MODAL DETALLE (con sufijo) ----------------------------------------------------------------------
function openModalDetalle(rec, suffix = ''){
  // limpiar contenido previo
  modalDetalleContent.innerHTML = '';
  modalDetalleTitulo.innerHTML = '';

  // título del modal
  const tituloMostrar = getField(rec, ['Mostrar', 'mostrar']) || '';
  modalDetalleTitulo.textContent = ` ${tituloMostrar}`;

  function valueOf(names){
    const v = getField(rec, names);
    return (v === undefined || v === null) ? '' : String(v).trim();
  }

  // helper: construye el nombre de columna con sufijo
  function col(base){
    return suffix ? `${base} ${suffix}` : base;
  }

  // campos a mostrar (según rama)
  const fields = [
    { label: 'Código de inscripción en SILA', names: [ col('Código de inscripción en SILA') ] },
    { label: 'Modalidad de inscripción',     names: [ col('Modalidad de inscripción') ] },
    { label: 'Alcance de la Autorización',   names: [ col('Alcance de la Autorización') ] },
    { label: 'Observaciones',                names: [ col('Observaciones') ], boldTitle: true }
  ];

  let anyField = false;

  fields.forEach(f => {
    const val = valueOf(f.names);
    if(val){
      anyField = true;

      const row = document.createElement('div');
      row.className = 'field';

      const strongTitle = document.createElement(f.boldTitle ? 'strong' : 'span');
      strongTitle.textContent = f.label + ': ';
      row.appendChild(strongTitle);

      const valueElement = document.createElement(f.boldTitle ? 'span' : 'strong');
      valueElement.innerHTML = renderBoldMarkdown(val);

      row.appendChild(valueElement);
      modalDetalleContent.appendChild(row);
    }
  });

  // Documentación (según rama)
  const docKey = col('Documentación');
  const docVal = valueOf([docKey, docKey.replace('ó','o')]); // mini tolerancia

  if(docVal){
    anyField = true;

    const row = document.createElement('div');
    row.className = 'field';

    const title = document.createElement('span');
    title.textContent = 'Documentación/enlace: ';
    row.appendChild(title);

    const valStrong = document.createElement('strong');

    if(/^https?:\/\//i.test(docVal) || docVal.includes('/') || /\.(pdf|docx?|xlsx?)$/i.test(docVal)) {
      const a = document.createElement('a');
      a.href = docVal;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = 'Acceder al documento / enlace';
      valStrong.appendChild(a);
    } else {
      valStrong.innerHTML = renderBoldMarkdown(docVal);
    }

    row.appendChild(valStrong);
    modalDetalleContent.appendChild(row);
  }

  if(!anyField){
    const none = document.createElement('div');
    none.className = 'small';
    none.textContent = 'No hay datos para mostrar en este registro.';
    modalDetalleContent.appendChild(none);
  }

  modalDetalle.style.display = 'flex';
  modalDetalle.setAttribute('aria-hidden','false');
}
  
function closeModalPreguntas(){
  modalPreguntas.style.display = 'none';
  modalPreguntas.setAttribute('aria-hidden','true');
  modalPreguntasContent.innerHTML = '';
}

btnCancelarPreguntas.addEventListener('click', closeModalPreguntas);

// Decide qué modal abrir
function openRecord(rec){
  const tipo = (getField(rec, ['Opciones_Pregunta','opciones_pregunta']) || '').trim().toLowerCase();
  const p1 = (getField(rec, ['Pregunta1','pregunta1']) || '').trim();

  // si no hay tipo o no hay pregunta, abrimos directamente rama A (normal)
  if(!tipo || !p1){
    openModalDetalle(rec, ''); // A
    return;
  }

  openModalPreguntas(rec, tipo);
}

  function parseDateInputToDate(value){
  // value esperado: "YYYY-MM-DD"
  if(!value) return null;
  const d = new Date(value + 'T00:00:00');
  return isNaN(d.getTime()) ? null : d;
}
function addYears(date, years){
  const d = new Date(date);
  d.setFullYear(d.getFullYear() + years);
  return d;
}
function addDays(date, days){
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
}

let _pregState = { rec:null, tipo:'', selectedBranch:null };

function openModalPreguntas(rec, tipo){
  _pregState = { rec, tipo, selectedBranch: null };

  modalPreguntasContent.innerHTML = '';
  modalPreguntasTitulo.textContent = (getField(rec, ['Mostrar','mostrar']) || '').trim();

  const p1 = (getField(rec, ['Pregunta1']) || '').trim();
  const p2 = (getField(rec, ['Pregunta2']) || '').trim();

  // pinta pregunta 1
  const q1 = document.createElement('div');
  q1.className = 'field';
  q1.innerHTML = `<strong> ${renderBoldMarkdown(p1)}</strong>`; //  q1.innerHTML = `Pregunta:<strong> ${renderBoldMarkdown(p1)}</strong>`;
  modalPreguntasContent.appendChild(q1);

  // pinta pregunta 2 si existe
  if(p2){
    const q2 = document.createElement('div');
    q2.className = 'field';
    q2.innerHTML =  `<strong> ${renderBoldMarkdown(p2)}</strong>`; //    q2.innerHTML = `<strong>Pregunta 2:</strong> ${renderBoldMarkdown(p2)}`;
    modalPreguntasContent.appendChild(q2);
  }

  // contenedor inputs / opciones
  const box = document.createElement('div');
  box.className = 'field';

  if(tipo === 'abc'){
    const oa = (getField(rec, ['Opción a','Opcion a']) || 'Opción A').trim();
    const ob = (getField(rec, ['Opción b','Opcion b']) || 'Opción B').trim();
    const oc = (getField(rec, ['Opción c','Opcion c']) || '').trim();

    box.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="radio" name="branchABC" value="a"> <strong>A</strong>: ${renderBoldMarkdown(oa)}
        </label>
        <label style="display:flex;gap:8px;align-items:center">
          <input type="radio" name="branchABC" value="b"> <strong>B</strong>: ${renderBoldMarkdown(ob)}
        </label>
        ${oc ? `
        <label style="display:flex;gap:8px;align-items:center">
          <input type="radio" name="branchABC" value="c"> <strong>C</strong>: ${renderBoldMarkdown(oc)}
        </label>` : ``}
      </div>
      <div class="small" style="margin-top:8px">Selecciona una opción para continuar.</div>
    `;
  }
  else if(tipo === 'fecha'){
    // 1 fecha, calculamos A/B/C con 30 y 180 días (según tu JSON)
    box.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <label><strong>Fecha:</strong> <input id="pregFecha1" type="date"></label>
        <div class="small">Se calculará automáticamente si corresponde A/B/C (30 y 180 días).</div>
      </div>
    `;
  }
  else if(tipo === 'dosfechas'){
    box.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <label><strong>Fecha expedición (TIE):</strong> <input id="pregFechaExp" type="date"></label>
        <label><strong>Fecha nacimiento:</strong> <input id="pregFechaNac" type="date"></label>
        <div class="small">Se calculará automáticamente la rama A/B/C.</div>
      </div>
    `;
  }
  else {
    box.innerHTML = `<div class="small">Tipo de pregunta no soportado: <strong>${tipo}</strong></div>`;
  }

  modalPreguntasContent.appendChild(box);

  modalPreguntas.style.display = 'flex';
  modalPreguntas.setAttribute('aria-hidden','false');
}

// continuar: decide rama y abre detalle con sufijo
btnContinuarPreguntas.addEventListener('click', () => {
  const rec = _pregState.rec;
  const tipo = _pregState.tipo;
  if(!rec) return;

  let branch = null; // 'a' | 'b' | 'c'

  if(tipo === 'abc'){
    const checked = document.querySelector('input[name="branchABC"]:checked');
    if(!checked){
      alert('Selecciona una opción (A/B/C).');
      return;
    }
    branch = checked.value;
  }

  if(tipo === 'fecha'){
    const v = document.getElementById('pregFecha1')?.value || '';
    const fecha = parseDateInputToDate(v);
    if(!fecha){
      alert('Introduce una fecha válida.');
      return;
    }
    const hoy = new Date();
    const plus30  = addDays(fecha, 30);
    const plus180 = addDays(fecha, 180);

    // A: ahora() > fecha + 180
    if(hoy > plus180) branch = 'a';
    // B: ahora() entre +30 y +180 (incluidos)
    else if(hoy >= plus30 && hoy <= plus180) branch = 'b';
    // C: ahora() < +30
    else branch = 'c';
  }

  if(tipo === 'dosfechas'){
    const expV = document.getElementById('pregFechaExp')?.value || '';
    const nacV = document.getElementById('pregFechaNac')?.value || '';

    const exp = parseDateInputToDate(expV);
    const nac = parseDateInputToDate(nacV);

    if(!exp || !nac){
      alert('Introduce ambas fechas (expedición y nacimiento).');
      return;
    }

    const hoy = new Date();
    const date16 = addYears(nac, 16);
    const date18 = addYears(nac, 18);

    // A: (exp < nac+16) y (nac+16 <= hoy)
    if(exp < date16 && date16 <= hoy) branch = 'a';
    // B: exp >= nac+18
    else if(exp >= date18) branch = 'b';
    // C: resto
    else branch = 'c';
  }

  // mapeo rama -> sufijo de columnas
  const suffix = (branch === 'a') ? '' : (branch === 'b') ? 'OPCIONAL' : 'OPCIONAL2';

  closeModalPreguntas();
  openModalDetalle(rec, suffix);
});


  function closeModalDetalle(){
    modalDetalle.style.display='none';
    modalDetalle.setAttribute('aria-hidden','true');
  }

  btnVolverDetalle.addEventListener('click', closeModalDetalle);

  // --- Carga JSON ---
  async function loadJSON(){
    try{
      const res = await fetch('./SituacionesAdministrativas.json', {cache:'no-store'});
      if(!res.ok) throw new Error('No se pudo cargar SituacionesAdministrativas.json');
      db = await res.json();
      console.log('Registros cargados:', db.length);
    }catch(err){
      resultsEl.innerHTML =
        `<div class="small" style="color:#c62828">Error al cargar JSON: ${err.message}</div>`;
    }
  }
  loadJSON();

const searchWrapper = document.querySelector('.search-input-wrapper');

searchWrapper.addEventListener('click', e => {
  if (searchInput.disabled) {
    // mostrar mensaje
    msgDisabled.classList.add('show');
    setTimeout(() => msgDisabled.classList.remove('show'), 3000);

    // opcional: evitar que se haga focus
    searchInput.blur();
  }
});

  
  // --- Filtros SILA ---
  function syncNadaLogic(changed){
    if(changed==='nada' && chkNada.checked){
      chkInscrito.checked=false;
      chkPrestacion.checked=false;
    }
    if((changed==='inscrito'||changed==='prestacion') &&
       (chkInscrito.checked||chkPrestacion.checked)){
      chkNada.checked=false;
    }
  }

function actualizarChecks(){
  syncNadaLogic();

  const anyChecked = (chkInscrito.checked || chkPrestacion.checked || chkNada.checked);

  if (anyChecked) {

      // habilitar
      searchInput.disabled = false;
      btnSearch.disabled = false;

      // borrar texto SIEMPRE al desbloquear
      searchInput.value = '';

      // activar estilo de campo activo
      searchInput.classList.add("enabled");

      // activar la animación
      searchInput.classList.add("flash");
      setTimeout(() => searchInput.classList.remove("flash"), 400);

      // llevar el cursor al input
      searchInput.focus();

  } else {

      searchInput.disabled = true;
      btnSearch.disabled = true;

      searchInput.value = '';
      resultsEl.innerHTML = '';
      countResults.textContent = '0';

      // quitar estilos
      searchInput.classList.remove("enabled");
      searchInput.classList.remove("flash");
  }
}



  chkInscrito.addEventListener('change', ()=>{ syncNadaLogic('inscrito'); actualizarChecks(); });
  chkPrestacion.addEventListener('change', ()=>{ syncNadaLogic('prestacion'); actualizarChecks(); });
  chkNada.addEventListener('change', ()=>{ syncNadaLogic('nada'); actualizarChecks(); });

  actualizarChecks();

 
function doSearch() {
  resultsEl.innerHTML = '';
  const rawQuery = searchInput.value.trim();
  if (!rawQuery) {
    resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>';
    countResults.textContent = '0';
    return;
  }

  // --- Normalización ---
  function normalize(s) {
    if (!s) return '';
    return String(s)
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .replace(/[^\p{L}\p{N}]+/gu,' ')
      .toLowerCase()
      .trim();
  }

  // --- Tokenización ---
  const STOPWORDS = new Set(['a','la','el','los','las','de','del','y','o','en','por','para','con','sin','que','un','una','al','se','su','sus']);
  function tokenizeQuery(q) {
    const norm = normalize(q);
    if (!norm) return [];
    const toks = Array.from(new Set(norm.split(/\s+/).filter(Boolean)));
    const filtered = toks.filter(t => !STOPWORDS.has(t));
    const merged = [];
    for (let i = 0; i < filtered.length; i++) {
      if (filtered[i] === 'no' && filtered[i + 1] === 'autoriza') {
        merged.push('no autoriza');
        i++;
      } else {
        merged.push(filtered[i]);
      }
    }
    return merged.length > 0 ? merged : filtered;
  }

  // --- Levenshtein para tolerancia ---
  function levenshtein(a, b) {
    const matrix = Array.from({ length: a.length + 1 }, (_, i) =>
      Array.from({ length: b.length + 1 }, (__, j) => i === 0 ? j : j === 0 ? i : 0)
    );
    for (let i = 1; i <= a.length; i++) {
      for (let j = 1; j <= b.length; j++) {
        const cost = a[i - 1] === b[j - 1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost
        );
      }
    }
    return matrix[a.length][b.length];
  }

  function containsTokenExact(text, token) {
    const words = text.split(/\s+/).map(w => w.toLowerCase());
    token = token.toLowerCase();
    if (token === 'autoriza') {
      for (let i = 0; i < words.length; i++) {
        if (words[i] === 'autoriza' && (i === 0 || words[i-1] !== 'no')) return true;
      }
      return false;
    }
    if (token === 'no autoriza') {
      for (let i = 0; i < words.length - 1; i++) {
        if (words[i] === 'no' && words[i+1] === 'autoriza') return true;
      }
      return false;
    }
    return words.includes(token);
  }

function containsTokenTolerant(text, token) {
  const words = text.split(/\s+/);
  token = token.toLowerCase();

  for (const w of words) {
    const word = w.toLowerCase();

    // 1. Exacta
    if (word === token) return true;

    // 2. Prefijo (inicio de palabra)
    if (word.startsWith(token) && token.length >= 3) return true;

    // 3. Tolerancia por Levenshtein
    if (token.length >= 4 && word.length >= 4) {
      const maxLen = Math.max(word.length, token.length);
      const threshold = Math.max(1, Math.ceil(maxLen * 0.2)); // ahora 20% en vez de 10%
      if (levenshtein(word, token) <= threshold) return true;
    }
  }

  return false;
}


  function extractQuotedPhrases(text) {
    const quotes = [];
    for (const m of text.matchAll(/"([^"]+)"/g)) {
      quotes.push(normalize(m[1]));
    }
    const normalizedText = normalize(text);
    return { quotes, normalizedText };
  }

  const tokens = tokenizeQuery(rawQuery);
  if (tokens.length === 0) {
    resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>';
    countResults.textContent = '0';
    return;
  }
  const queryNorm = normalize(rawQuery);

  // --- Función central de coincidencia ---
  function recordMatches(rec, tokens, queryNorm, tolerant=false) {
    const anversoRaw = getField(rec, ['ANVERSO','Anverso','anverso']) || '';
    const reversoRaw = getField(rec, ['REVERSO','Reverso','reverso']) || '';
    const combinedRaw = `${anversoRaw} ${reversoRaw}`.trim();
    const { quotes: quotedPhrases, normalizedText: combinedNorm } = extractQuotedPhrases(combinedRaw);

    // frases entre comillas
    for (const qp of quotedPhrases) {
      if (!queryNorm.includes(qp)) {
        const qpWords = qp.split(/\s+/).filter(Boolean);
        for (const tok of tokens) {
          if (qpWords.includes(tok)) return false;
        }
      }
    }

    // validar tokens
    for (const tok of tokens) {
      if (tok === 'autoriza') {
        if (!combinedNorm.includes('autoriza') || combinedNorm.includes('no autoriza')) return false;
      } else if (tok === 'no autoriza') {
        if (!combinedNorm.includes('no autoriza')) return false;
      } else if (quotedPhrases.includes(tok)) {
        continue;
      } else {
        if (tolerant) {
          if (!containsTokenTolerant(combinedNorm, tok)) return false;
        } else {
          if (!containsTokenExact(combinedNorm, tok)) return false;
        }
      }
    }

    return true;
  }

  // --- Fase 1: búsqueda estricta ---
  let matches = db.map((rec, idx) => recordMatches(rec, tokens, queryNorm, false) ? {rec, idx} : null).filter(Boolean);

  // --- Fase 2: búsqueda tolerante ---
  if (matches.length === 0) {
    matches = db.map((rec, idx) => recordMatches(rec, tokens, queryNorm, true) ? {rec, idx} : null).filter(Boolean);
  }

  // --- Mostrar resultados ---
  if (matches.length === 0) {
    resultsEl.innerHTML = '<div class="small">No se han encontrado registros con el filtro aplicado.</div>';
    countResults.textContent = '0';
    return;
  }
  // --- Si hay un único resultado, abrir directamente el modal ---
  if (matches.length === 1) {
    countResults.textContent = '1';
    const único = matches[0].rec;
    // Abrimos modal
    openRecord(único);
    // Limpiamos la lista (ya que no vamos a mostrar resultados)
    resultsEl.innerHTML = '';
    return; // Muy importante para que NO siga creando la lista
  }

  countResults.textContent = String(matches.length);
matches.forEach(m => {
    const rec = m.rec;

    const wrapper = document.createElement('div');
    wrapper.className = 'result-item';
    wrapper.style.cursor = 'pointer';
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center'; // centra verticalmente

    // --- Checkbox ---
    const chkWrap = document.createElement('div');
    chkWrap.className = 'check';
    chkWrap.style.display = 'flex';
    chkWrap.style.alignItems = 'center';

    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.name = 'selectRec';
    chk.dataset.index = m.idx;
    chkWrap.appendChild(chk);

    // --- Contenido ---
    const content = document.createElement('div');
    content.style.flex = '1';
    content.style.display = 'flex';       // fuerza línea horizontal
    content.style.alignItems = 'center';  // centra vertical
    content.style.gap = '4px';            // opcional, separación entre elementos internos

    const title = document.createElement('h4');
    title.style.margin = '0';             // elimina márgenes que generan salto de línea
    title.innerHTML = getField(rec, ['Mostrar', 'mostrar']) || 'Registro sin campo Mostrar';

    content.appendChild(title);

    // --- Añadir al wrapper ---
    wrapper.appendChild(chkWrap);
    wrapper.appendChild(content);

    // --- Eventos ---
    wrapper.addEventListener('click', e => {
        if (e.target.tagName.toLowerCase() === 'input') return;
        const all = Array.from(document.querySelectorAll('input[name="selectRec"]'));
        all.forEach(inp => inp.checked = false);
        chk.checked = true;
        openRecord(rec);
    });

    chk.addEventListener('change', e => {
        const all = Array.from(document.querySelectorAll('input[name="selectRec"]'));
        all.forEach(inp => { if (inp !== e.target) inp.checked = false; });
        if (e.target.checked) openRecord(rec);
    });

    resultsEl.appendChild(wrapper);
});

}



  btnSearch.addEventListener('click', doSearch);
  
  const msgDisabled = document.getElementById('msgDisabled');
  
  searchInput.addEventListener('keydown', e => {
    if (searchInput.disabled) {
      e.preventDefault(); // evita que escriba
      
      // Mostrar mensaje
      msgDisabled.classList.add('show');
  
      // Ocultar mensaje después de 3 segundos
      setTimeout(() => {
        msgDisabled.classList.remove('show');
      }, 3000);
  
    } else if (e.key === 'Enter') {
      doSearch();
    }
  });


});
</script>


</body>
</html>
