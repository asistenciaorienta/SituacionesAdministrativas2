<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ASIM-SAE ‚Äî Aplicaci√≥n de soporte para la inscripci√≥n de migrantes</title>
<style>
:root{
  --sae-green:#007A33;
  --muted:#6b6b6b;
  --card-bg:#fff;
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Arial;
}
html,body{height:100%;margin:0;background:#f5f5f5;  display: flex;  flex-direction: column;}
.container {  flex: 1; /* ocupa todo el espacio disponible entre header y footer */
  display: flex;
  flex-direction: column;
}
header {position: relative;display:flex;align-items:center;gap:12px;padding:8px 20px;justify-content: space-between;} /* separa los logos a los lados */
header .logo-izquierda{height:60px; object-fit: contain;flex-shrink: 0;}
header .logo-derecha{height:75px; object-fit: contain;flex-shrink: 0;}
header h1{margin:0;color:var(--sae-green);font-size:30px}
header h2{margin:0;font-size:19px;color:var(--muted)}
header .titulo-header {position: absolute;text-align: center;flex: 1;left: 50%;transform: translateX(-50%);white-space: nowrap;}    
.search-container { display:flex; flex-direction:column; align-items:center; margin: 15px auto; width:100%; max-width:950px; background:white; padding:15px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.search-container2 { display:flex; flex-direction:column; align-items:center; margin: 15px auto; width:100%; max-width:950px; background:white; padding:15px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.search-intro { text-align:center; width:100%; margin-bottom:8px; font-size:17px; color:#222; }
.filters { display:flex; gap:18px; width:100%; justify-content: center; flex-wrap:wrap; margin-bottom:14px; }
.filters label { display:flex; align-items:center; gap:8px; font-size:0.95rem; color:#222; }
.filters input[type="checkbox"]{ width:16px; height:16px; }
#searchArea{ width:100%; display:flex; flex-direction:column; gap:10px }
.search-top{ display:flex; gap:10px; align-items:center }
.search-top input{ flex:1; padding:12px 14px; border-radius:8px; border:1px solid #dfeee0; font-size:16px }
.search-top button{ padding:11px 18px; border-radius:8px; border:none; background:var(--sae-green); color:#fff; font-weight:600; cursor:pointer }
.search-top button[disabled]{ opacity:0.5; cursor:not-allowed }
.search-meta{ display:flex; justify-content:space-between; color:var(--muted); font-size:13px; }
.results{ margin-top:8px }
.result-item{ display:flex; gap:12px; padding:10px; border-radius:8px; border:1px solid #e6efe7; background:#fff; margin-bottom:8px; cursor:pointer }
.result-item h3{ margin:0;font-size:15px }
.result-item p{ margin:6px 0 0;color:var(--muted);font-size:13px }
.modal-backdrop{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:9999 }
.modal{ background:var(--card-bg); border-radius:10px; padding:0; width:90%; max-width:720px; max-height:80vh; overflow:auto; box-shadow:0 20px 40px rgba(0,0,0,0.25) }
.modal-header-sae{ background:var(--sae-green); color:#fff; padding:14px 18px; border-top-left-radius:10px; border-top-right-radius:10px }
.modal-body-sae{ padding:16px 18px; line-height:1.8;   /* interlineado mayor */ }
.actions{ display:flex; gap:10px; justify-content:center; padding:12px }  
.actions button{ padding:11px 18px; border-radius:8px; border:none; background:var(--sae-green); color:#fff; font-weight:600; cursor:pointer }
.no-data{ color:var(--muted); font-style:italic }
@media (max-width:600px){ .filters{flex-direction:column;align-items:flex-start} }
footer {
  display: flex;
  justify-content: space-between; /* uno a la izquierda, otro a la derecha */
  align-items: center;           /* centrado vertical */
  padding: 10px 20px;
  background-color: #f5f5f5;
  flex-wrap: wrap;               /* opcional: que se adapten en pantallas peque√±as */
}

.footer-logo, .footer-datos {
  font-size: 13px;
  color:var(--muted);  
}
.footer-logo .logo-text {
  left: 0;}
  
.results .small {
  color: #1b5e20;
  font-size: 15px;
  margin-bottom: 6px;
}
#doc ul {
  margin: 8px 0 0 20px;   /* separaci√≥n y sangr√≠a */
  padding: 0;
  list-style-type: disc;  /* tipo de vi√±eta: disc, circle, square */
}

#doc li {
  margin-bottom: 6px;     /* espacio entre elementos */
  font-size: 15px;
  color: #333;
}
.results .result-item p {
  white-space: pre-wrap; /* mantiene saltos de l√≠nea */
}
.search-input-wrapper {
  position: relative;
  width: 100%;
}

#searchInput {
  width: 100%;
  padding-right: 32px; /* espacio para la cruz */
  height: 36px;
  font-size: 14px;
  box-sizing: border-box;
  /* background: #94EB9D;*/
}

#searchInput {
  background-color: #72D677;  /* color cuando est√° deshabilitado */
  transition: background-color 0.3s ease;
  color: #757575;
}

#searchInput.enabled {
  background-color: #E9FFE5;  /* color cuando est√° habilitado */
  color: #000;
}
/* Estilo del placeholder cuando est√° deshabilitado */
#searchInput:disabled::placeholder {
  color: #757575;  /* gris suave */
}

/* Ocultar placeholder cuando est√° habilitado */
#searchInput.enabled::placeholder {
  color: transparent;
}
  

.clear-btn-wrapper {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
}

.clear-icon {
  width: 16px;
  height: 16px;
  stroke: black;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
  background: none;
  pointer-events: none;
}
/* Animaci√≥n suave al activarse el campo */
@keyframes inputFlash {
  0%   { background-color: #d8f5d2; }   /* verde clarito */
  100% { background-color: white; }
}

input.enabled.flash {
  animation: inputFlash 0.4s ease-out;
}

</style>
</head>
<body>
<div class="container">
  <header>
    <img class="logo-izquierda" src="images/SAE_Junta_de_Andalucia_Documentacion.png" alt="Logo Junta de Andaluc√≠a">
    <div class="titulo-header">
      <h1>ASIM-SAE</h1>
      <h2>Aplicaci√≥n de soporte para la inscripci√≥n de migrantes</h2>
    </div>
    <img class="logo-derecha" src="images/Logo_SILA_Migrantes2_corto.png" alt="Logo proyecto">
  </header>
  
  <div id="doc" class="search-container">
    <p><strong>Documentaci√≥n necesaria para la inscripci√≥n de una persona extranjera:</strong></p>
    <ul>
      <li>Identificaci√≥n de la persona usuaria: documentaci√≥n expedida por Espa√±a con foto (Tarjeta TIE, Resoluci√≥n con Foto, Pasaporte).</li>
      <li>Tarjeta TIE o Resoluci√≥n en Vigor.</li>
      <li>Solicitud (s√≥lo en los casos habilitados).</li>
    </ul>
  </div>

  <div class="search-container2" role="region" aria-labelledby="intro">  
    <div id="intro" class="search-intro">
      <p><strong>Consulta SILA y marca lo que corresponda:</strong></p>
    </div>

    <div class="filters" aria-label="Opciones SILA">
      <label><input type="checkbox" id="chkInscrito"> Consta una inscripci√≥n previa en SILA</label>
      <label><input type="checkbox" id="chkPrestacion"> Cobra prestaci√≥n o subsidio</label>
      <label><input type="checkbox" id="chkNada"> Inscripci√≥n Inicial</label>
    </div>

  <div id="searchArea" class="search-area" aria-live="polite">
    <div class="search-top">
      <div class="search-input-wrapper">
        <input id="searchInput" type="text" placeholder="Introduce la denominaci√≥n de la autorizaci√≥n o solicitud a buscar‚Ä¶" aria-label="Introduce el texto a buscar" disabled>
        <span class="clear-btn-wrapper" id="clearSearchInline">
          <svg class="clear-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </span>
      </div>
      <button id="btnSearch" class="btn btn-nocomunitario">Buscar</button>
    </div>
    <div class="search-meta">
      <!-- <span class="small">Filtros SILA marcados: <span id="inscritoEstado" class="small no-data">no definido</span></span>-->
      <span class="small">Resultados: <span id="countResults">0</span></span>
    </div>
    <div class="results" id="results" aria-live="polite"></div>
    <div class="results" aria-live="polite" style="color:var(--muted);font-size:13px;text-align: center;" >La informaci√≥n ofrecida con esta herramienta es meramente orientativa y pretende ser un apoyo a la inscripci√≥n de las personas migrantes en SILA.<br> <u>En ning√∫n caso puede sustituir al sistema de resoluci√≥n de incidencias establecido v√≠a SAEclick.</u></div>
  </div>

  <div id="modalDetalle" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header-sae"><h3 id="modalDetalleTitulo"></h3></div>
      <div class="modal-body-sae" id="modalDetalleContent"></div>
      <div class="actions">
        <button id="btnVolverDetalle" class="btn">Volver</button>
      </div>
    </div>
  </div>
</div>  

</div>
  <footer>
    <div class="footer-logo">
      <div class="logo-text"><b>Versi√≥n 6.23 ‚Äî Direcci√≥n Provincial de Granada</b> </div>
    </div>
    <div class="footer-datos">
      <b>Apoyo durante la fase de testeo, para la resoluci√≥n de dudas y la recogida de incidencias:</b><br>
      <hr>
      Elisabeth Huertas Garc√≠a &lt;<a href="mailto:elisabeth.huertas.garcia@juntadeandalucia.es">elisabeth.huertas.garcia@juntadeandalucia.es</a>&gt; ‚Äì 765145<br>
      Jos√© Manuel Robles Chaves &lt;<a href="mailto:josem.robles@juntadeandalucia.es">josem.robles@juntadeandalucia.es</a>&gt; ‚Äì 653467
    </div>
  </footer>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Elementos ---
  const chkInscrito = document.getElementById('chkInscrito');
  const chkPrestacion = document.getElementById('chkPrestacion');
  const chkNada = document.getElementById('chkNada');
  const estadoChecks = document.getElementById('inscritoEstado');

  const searchInput = document.getElementById('searchInput');
  const btnSearch = document.getElementById('btnSearch');
  const resultsEl = document.getElementById('results');
  const countResults = document.getElementById('countResults');

  const modalDetalle = document.getElementById('modalDetalle');  
  const modalDetalleTitulo = document.getElementById('modalDetalleTitulo');
  const modalDetalleContent = document.getElementById('modalDetalleContent');
  const btnVolverDetalle = document.getElementById('btnVolverDetalle');

  const clearSearchInline = document.getElementById('clearSearchInline');
  if (clearSearchInline) {
    clearSearchInline.addEventListener('click', () => {
      searchInput.value = '';
      resultsEl.innerHTML = '';
      countResults.textContent = '0';
      searchInput.focus();
    });
  }

  let db = [];
  let userInscritoAnswer = null;

  // --- Utilidades ---
  function getField(obj, possibleNames){
    const keys = Object.keys(obj);
    for(const n of possibleNames){
      const normN = n.trim().toLowerCase();
      for(const key of keys){
        if(key.trim().toLowerCase() === normN) return obj[key];
      }
    }
    return undefined;
  }


  function normalize(s){
    if(!s) return '';
    return String(s)
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .replace(/[^\p{L}\p{N}]+/gu,' ')
      .toLowerCase()
      .trim();
  }

  const STOPWORDS = new Set(['a','la','el','los','las','de','del','y','o','en','por','para','con','sin','que','un','una','al','se','su','sus']);

  function tokenizeQuery(q) {
    const norm = normalize(q);
    if (!norm) return [];
    const toks = Array.from(new Set(norm.split(/\s+/).filter(Boolean)));
    const filtered = toks.filter(t => !STOPWORDS.has(t));

    // ‚Äúno autoriza‚Äù
    const merged = [];
    for (let i = 0; i < filtered.length; i++) {
      if (filtered[i] === 'no' && filtered[i + 1] === 'autoriza') {
        merged.push('no autoriza');
        i++;
      } else {
        merged.push(filtered[i]);
      }
    }
    return merged.length > 0 ? merged : filtered;
  }

  // --- MODAL DETALLE ----------------------------------------------------------------------
function openModalDetalle(rec){
  // limpiar contenido previo
  modalDetalleContent.innerHTML = '';
  modalDetalleTitulo.innerHTML = '';
  
  // ‚ûú Obtener el campo Mostrar del registro
  const tituloMostrar = getField(rec, ['Mostrar', 'mostrar']) || '';
  
  // ‚ûú Asignarlo al t√≠tulo del modal
  modalDetalleTitulo.textContent = `Datos para la Inscripci√≥n: ${tituloMostrar}`;  

  // helper
  function valueOf(names){
    const v = getField(rec, names);
    return (v === undefined || v === null) ? '' : String(v).trim();
  }

  // campos a mostrar
  const fields = [
    { label: 'C√≥digo de inscripci√≥n en SILA', names: ['C√≥digo de inscripci√≥n en SILA'] },    
    { label: 'Modalidad de inscripci√≥n', names: ['Modalidad de inscripci√≥n'] },
    { label: 'Alcance de la Autorizaci√≥n', names: ['Alcance de la Autorizaci√≥n'] },
    { label: 'Observaciones', names: ['Observaciones'], boldTitle: true }
  ];

  let anyField = false;

  fields.forEach(f => {
    const val = valueOf(f.names);
    if(val){
      anyField = true;
      const row = document.createElement('div');
      row.className = 'field';

      // t√≠tulo
      const strongTitle = document.createElement(f.boldTitle ? 'strong' : 'span');
      strongTitle.textContent = f.label + ': ';
      row.appendChild(strongTitle);

      // valor en negrita (menos Observaciones)
      const valueElement = document.createElement(f.boldTitle ? 'span' : 'strong');
      valueElement.textContent = val;

      row.appendChild(valueElement);
      modalDetalleContent.appendChild(row);
    }
  });

  // Documentaci√≥n
  const docVal = valueOf(['Documentaci√≥n','Documentacion','DOCUMENTACI√ìN']);
  if(docVal){
    anyField = true;

    const row = document.createElement('div');
    row.className = 'field';

    const title = document.createElement('span');
    title.textContent = 'Documentaci√≥n: ';
    row.appendChild(title);

    // valor en negrita si no es Observaciones
    const valStrong = document.createElement('strong');

    // enlace si parece URL
    if(/^https?:\/\//i.test(docVal) || docVal.includes('/') || /\.(pdf|docx?|xlsx?)$/i.test(docVal)) {
      const a = document.createElement('a');
      a.href = docVal;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = 'Ver documento';
      valStrong.appendChild(a);
    } else {
      valStrong.textContent = docVal;
    }

    row.appendChild(valStrong);
    modalDetalleContent.appendChild(row);
  }

  if(!anyField){
    const none = document.createElement('div');
    none.className = 'small';
    none.textContent = 'No hay datos para mostrar en este registro.';
    modalDetalleContent.appendChild(none);
  }

  modalDetalle.style.display = 'flex';
  modalDetalle.setAttribute('aria-hidden','false');
}




  function closeModalDetalle(){
    modalDetalle.style.display='none';
    modalDetalle.setAttribute('aria-hidden','true');
  }

  btnVolverDetalle.addEventListener('click', closeModalDetalle);

  // --- Carga JSON ---
  async function loadJSON(){
    try{
      const res = await fetch('./SituacionesAdministrativas.json', {cache:'no-store'});
      if(!res.ok) throw new Error('No se pudo cargar SituacionesAdministrativas.json');
      db = await res.json();
      console.log('Registros cargados:', db.length);
    }catch(err){
      resultsEl.innerHTML =
        `<div class="small" style="color:#c62828">Error al cargar JSON: ${err.message}</div>`;
    }
  }
  loadJSON();

const searchWrapper = document.querySelector('.search-input-wrapper');

searchWrapper.addEventListener('click', e => {
  if (searchInput.disabled) {
    // mostrar mensaje
    msgDisabled.classList.add('show');
    setTimeout(() => msgDisabled.classList.remove('show'), 3000);

    // opcional: evitar que se haga focus
    searchInput.blur();
  }
});

  
  // --- Filtros SILA ---
  function syncNadaLogic(changed){
    if(changed==='nada' && chkNada.checked){
      chkInscrito.checked=false;
      chkPrestacion.checked=false;
    }
    if((changed==='inscrito'||changed==='prestacion') &&
       (chkInscrito.checked||chkPrestacion.checked)){
      chkNada.checked=false;
    }
  }

function actualizarChecks(){
  syncNadaLogic();

  const anyChecked = (chkInscrito.checked || chkPrestacion.checked || chkNada.checked);

  if (anyChecked) {

      // habilitar
      searchInput.disabled = false;
      btnSearch.disabled = false;

      // borrar texto SIEMPRE al desbloquear
      searchInput.value = '';

      // activar estilo de campo activo
      searchInput.classList.add("enabled");

      // activar la animaci√≥n
      searchInput.classList.add("flash");
      setTimeout(() => searchInput.classList.remove("flash"), 400);

      // llevar el cursor al input
      searchInput.focus();

  } else {

      searchInput.disabled = true;
      btnSearch.disabled = true;

      searchInput.value = '';
      resultsEl.innerHTML = '';
      countResults.textContent = '0';

      // quitar estilos
      searchInput.classList.remove("enabled");
      searchInput.classList.remove("flash");
  }
}



  chkInscrito.addEventListener('change', ()=>{ syncNadaLogic('inscrito'); actualizarChecks(); });
  chkPrestacion.addEventListener('change', ()=>{ syncNadaLogic('prestacion'); actualizarChecks(); });
  chkNada.addEventListener('change', ()=>{ syncNadaLogic('nada'); actualizarChecks(); });

  actualizarChecks();

  // Normalizador exacto de tokens
function containsTokenExact(text, token) {
  const words = text.split(/\s+/).filter(Boolean);
  token = token.toLowerCase();

  // --- Control especial "autoriza" y "no autoriza" ---
  if (token === 'autoriza') {
    for (let i = 0; i < words.length; i++) {
      if (words[i] === 'autoriza') {
        if (i === 0 || words[i - 1] !== 'no') return true;
      }
    }
    return false;
  }

  if (token === 'no autoriza') {
    for (let i = 0; i < words.length - 1; i++) {
      if (words[i] === 'no' && words[i + 1] === 'autoriza') return true;
    }
    return false;
  }

  // --- Coincidencias normales con tolerancia adaptativa ---
  for (const w of words) {
    const wnorm = w.toLowerCase();

    // coincidencia directa / parcial
    if (wnorm === token || wnorm.includes(token) || token.includes(wnorm))
      return true;

    // tolerancia (Levenshtein) con umbral adaptativo:
    const maxLen = Math.max(wnorm.length, token.length);

    // regla: para palabras muy cortas (<=4) permitir como m√°ximo 1 error,
    // para palabras medianas/grandes usar 10% redondeado pero nunca menos de 1.
    const umbral = (maxLen <= 4) ? 1 : Math.max(1, Math.ceil(maxLen * 0.10));

    if (levenshtein(wnorm, token) <= umbral)
      return true;
  }

  return false;
}



function levenshtein(a, b) {
  if (a.length === 0) return b.length;
  if (b.length === 0) return a.length;

  const matrix = [];

  for (let i = 0; i <= b.length; i++) matrix[i] = [i];
  for (let j = 0; j <= a.length; j++) matrix[0][j] = j;

  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      const cost = a[j - 1] === b[i - 1] ? 0 : 1;

      matrix[i][j] = Math.min(
        matrix[i - 1][j] + 1,
        matrix[i][j - 1] + 1,
        matrix[i - 1][j - 1] + cost
      );
    }
  }
  return matrix[b.length][a.length];
}


function palabraCoincide(palabra, texto) {
  const palabrasTexto = texto.toLowerCase().split(/\s+/);
  palabra = palabra.toLowerCase();

  for (const w of palabrasTexto) {

    if (w.includes(palabra) || palabra.includes(w)) return true;

    const maxLen = Math.max(w.length, palabra.length);
    const umbral = Math.max(2, Math.ceil(maxLen * 0.10));  // üî• tolerancia m√≠nima 2 errores

    if (levenshtein(palabra, w) <= umbral) {
      return true;
    }
  }

  return false;
}

  
// --- Funci√≥n auxiliar para extraer frases entrecomilladas ---
function extractQuotedPhrases(text) {
  // Devuelve { quotes: [..frases normalizadas..], normalizedText: texto normalizado entero }
  // Buscamos comillas dobles "..." dentro del propio valor.
  const quotes = [];
  for (const m of text.matchAll(/"([^"]+)"/g)) {
    quotes.push(normalize(m[1]));
  }
  const normalizedText = normalize(text);
  return { quotes, normalizedText };
}

/* doSearch reemplazado */
function doSearch() {
  resultsEl.innerHTML = '';
  const rawQuery = searchInput.value.trim();
  if (!rawQuery) {
    resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>';
    countResults.textContent = '0';
    return;
  }

  const tokens = tokenizeQuery(rawQuery); // tokens normalizados y sin stopwords
  if (tokens.length === 0) {
    resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>';
    countResults.textContent = '0';
    return;
  }

  const queryNorm = normalize(rawQuery); // cadena normalizada completa (√∫til para buscar frases completas)
  const matches = [];

  db.forEach((rec, idx) => {
    // filtro por inscripci√≥n (si aplica)
    const valInscritoAnterior = getField(rec, ['¬øInscrito anteriormente?', 'Inscrito anteriormente', 'INSCRITO ANTERIORMENTE', 'inscrito anteriormente']);
    const valNorm = valInscritoAnterior ? String(valInscritoAnterior).trim().toUpperCase() : '';
    const includeByInscrito = valNorm === '' || (userInscritoAnswer && valNorm === userInscritoAnswer);
    if (!includeByInscrito) return;

    const anversoRaw = getField(rec, ['ANVERSO','Anverso','anverso']) || '';
    const reversoRaw = getField(rec, ['REVERSO','Reverso','reverso']) || '';
    const combinedRaw = `${anversoRaw} ${reversoRaw}`.trim();

    // Extraer frases entrecomilladas y texto normalizado
    const { quotes: quotedPhrases, normalizedText: combinedNorm } = extractQuotedPhrases(combinedRaw);

    // Regla especial: si el registro contiene frases entrecomilladas,
    // y el usuario busca SOLO una parte de una de esas frases -> RECHAZAR.
    // Pero si el usuario ha buscado la frase completa (query incluye la frase completa) -> permitir.
    let rejectedBecausePartialQuoted = false;
    if (quotedPhrases.length > 0) {
      for (const qp of quotedPhrases) {
        // qp es la frase entrecomillada normalizada, p.ej. "tarjeta verde"
        // Si el usuario busc√≥ exactamente la frase (como substring normalizado) => OK
        if (queryNorm.includes(qp)) {
          // usuario busc√≥ la frase completa ‚Üí no rechazar por esta frase
          continue;
        }
        // Si el usuario incluye alguna palabra que forma parte de la frase entrecomillada
        // pero no la frase completa, rechazamos el registro.
        const qpWords = qp.split(/\s+/).filter(Boolean);
        for (const tok of tokens) {
          if (qpWords.includes(tok)) {
            // el usuario busca una palabra que forma parte de una frase entrecomillada
            // pero no busc√≥ la frase entera (ya comprobado arriba), as√≠ que rechazamos.
            rejectedBecausePartialQuoted = true;
            break;
          }
        }
        if (rejectedBecausePartialQuoted) break;
      }
    }
    if (rejectedBecausePartialQuoted) return; // no incluir este registro

    // Si pasamos las reglas de comillas, ahora comprobamos que todos los tokens est√©n presentes
    // en el texto normalizado (b√∫squeda por palabras)
    let allTokensFound = true;
    for (const tok of tokens) {
      if (!containsTokenExact(combinedNorm, tok)) {
        allTokensFound = false;
        break;
      }
    }
    if (allTokensFound) {
      matches.push({ rec, idx });
    }
  });

  if (matches.length === 0) {
    resultsEl.innerHTML = '<div class="small">No se han encontrado registros con el filtro aplicado.</div>';
    countResults.textContent = '0';
    return;
  }

  countResults.textContent = String(matches.length);

  matches.forEach(m => {
    const rec = m.rec;

    const wrapper = document.createElement('div');
    wrapper.className = 'result-item';
    wrapper.style.cursor = 'pointer';

    const chkWrap = document.createElement('div');
    chkWrap.className = 'check';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.name = 'selectRec';
    chk.dataset.index = m.idx;
    chkWrap.appendChild(chk);

    const content = document.createElement('div');
    content.style.flex = '1';
    const title = document.createElement('h3');
    title.textContent = getField(rec, ['Mostrar', 'mostrar']) || 'Registro sin campo Mostrar';
    const p = document.createElement('p');
    p.textContent = '';
    content.appendChild(title);
    content.appendChild(p);

    wrapper.appendChild(chkWrap);
    wrapper.appendChild(content);

    wrapper.addEventListener('click', e => {
      if (e.target.tagName.toLowerCase() === 'input') return;
      const all = Array.from(document.querySelectorAll('input[name="selectRec"]'));
      all.forEach(inp => inp.checked = false);
      chk.checked = true;
      openModalDetalle(rec);
    });

    chk.addEventListener('change', e => {
      const all = Array.from(document.querySelectorAll('input[name="selectRec"]'));
      all.forEach(inp => { if (inp !== e.target) inp.checked = false; });
      if (!e.target.checked) return;
      openModalDetalle(rec);
    });

    resultsEl.appendChild(wrapper);
  });
}


function recordMatchesSearch(rec, tokens) {
  const anversoRaw = getField(rec, ['ANVERSO', 'Anverso', 'anverso']) || '';
  const reversoRaw = getField(rec, ['REVERSO', 'Reverso', 'reverso']) || '';
  const combinedRaw = `${anversoRaw} ${reversoRaw}`.trim();

  const { quotes: quotedPhrases, noQuotes } = extractQuotedPhrases(combinedRaw);
  const combinedNorm = normalize(noQuotes);

  return tokens.every(tok => {
    const normTok = normalize(tok);

    // Si el registro contiene una frase entre comillas‚Ä¶
    if (quotedPhrases.includes(normTok)) {
      // ‚Ä¶solo coincide si el token es exactamente esa frase.
      return true;
    }

    // Si el token coincide con una frase entre comillas PERO NO es exacto ‚Üí no coincide
    if (quotedPhrases.some(q => q.includes(normTok) || normTok.includes(q))) {
      return false;
    }

    // Resto del texto: b√∫squeda normal por palabras
    return containsTokenExact(combinedNorm, normTok);
  });
}


  btnSearch.addEventListener('click', doSearch);
  
  const msgDisabled = document.getElementById('msgDisabled');
  
  searchInput.addEventListener('keydown', e => {
    if (searchInput.disabled) {
      e.preventDefault(); // evita que escriba
      
      // Mostrar mensaje
      msgDisabled.classList.add('show');
  
      // Ocultar mensaje despu√©s de 3 segundos
      setTimeout(() => {
        msgDisabled.classList.remove('show');
      }, 3000);
  
    } else if (e.key === 'Enter') {
      doSearch();
    }
  });


});
</script>


</body>
</html>
