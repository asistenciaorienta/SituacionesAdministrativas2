<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Formulario Unificado</title>
    <link rel="stylesheet" href="style.css?v=1.0">
    <!-- PIXI.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.12/pixi.min.js"></script>
    <!-- Live2D Cubism Core -->
    <script src="libs/Core/live2dcubismcore.min.js"></script>
    <!-- pixi-live2d-display con soporte Cubism 4 -->
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>
    <style>
      /* Hace que el body ocupe toda la altura de la ventana */
      html, body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: Arial, sans-serif;
        /*text-align: center;*/
        background: #f5f5f5;
        display: flex;
        justify-content: center; /* centrado horizontal */
        align-items: center;     /* centrado vertical */ 
      }
      
      #nacionalidad-page {
        max-width: 870px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        padding: 30px 20px 0px;
        margin: auto  auto 40px;
      }
      
      h1 {
        color: #007A33;
        margin-bottom: 24px;
      }
      
      h2 {
        color: #007A33;
        margin-bottom: 24px;
      }
      
      h3 {
        color: #007A33;
        margin-bottom: 24px;
      }
      .btn {
        background-color: #007A33;
        color: white;
        border: none;
        padding: 14px 32px;
        margin: 12px 14px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,122,51,0.4);
      }
      
      .btn:hover {
        background-color: #005e29;
        box-shadow: 0 4px 8px rgba(0,94,41,0.6);
      }
      
      img {
        max-width: 90%;
        max-height: 70vh;
        object-fit: contain;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      /* Estilos del formulario */
      .card {
        width: 870px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        overflow: hidden;
        padding: 12px 16px;
        margin: auto;
        text-align: left;
      }
      
      .search-container {
        display: flex;
        align-items: center;
        border-radius: 12px;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 0 0 2px #007A33;
        margin-bottom: 0px;
      }
      
      #search-box {
        width: 100%;
        padding: 10px;
        border: 0px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        resize: none;
        box-sizing: border-box;
      }
      
      .button-container {
        text-align: center;
        padding: 12px 0;
        border-top: 1px solid #ddd;
        margin-top: 10px;
      }
      
      #buscarBtn {
        background-color: #007A33;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
      }
      
      .btn-small {
        background-color: #ccc;
        color: #333;
        border: none;
        padding: 6px 16px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: none;
        margin-top: 12px;
        transition: background-color 0.3s ease;
      }
      
      .btn-small:hover {
        background-color: #bbb;
        padding: 10px 20px;
      }
      
      .nacionalidad-card {
        text-align: center;
        padding: 0;
      }
      
      .botones-nacionalidad {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
        flex-wrap: wrap;
        flex-direction:column;
        align-items:center;
        gap:30px;       
      }
      
      .btn-wrapper {
        position: relative;
        display: inline-block;
      }
      
      .tooltip-container {
        position: absolute;
        top: 15px;
        left: 18px;
      }
      
      .help-icon {
        background-color: #FFFFFF;
        color: #007A33;
        border-radius: 30%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        line-height: 20px;
        cursor: pointer;
        z-index: 2;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      }
      
      .tooltip-text {
        visibility: hidden;
        width: 340px;
        background-color: white;
        color: #333;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        top: 50px;
        left: -100px;
        z-index: 5;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        line-height: 1.5; /* Interlineado, 1.5 veces la altura de la fuente */  
        text-align: justify;    /* justifica el texto */
      }
      
      .tooltip-container:hover .tooltip-text {
        visibility: visible;
      }
      
      .document-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        /* max-width: 800px;*/
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        padding: 30px 20px 40px;
        margin: auto  auto 40px;
      }
      
      .document-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        color: #000;
        cursor: pointer;
      }
      
      .document-item input[type="radio"] {
        appearance: none;
        border: 2px solid #007A33;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        position: relative;
        margin: 0;
      }
      
      .document-item input[type="radio"]:checked::before {
        content: "";
        position: absolute;
        background: #007A33;
        border-radius: 50%;
        width: 10px;
        height: 10px;
        top: 3px;
        left: 3px;
      }
      
      .sub-options {
        margin-left: 48px;
        margin-top: -5px;
        margin-bottom: 10px;
        display: none;
        flex-direction: column;
        gap: 8px;
      }
      
      .sub-options label {
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      
      .sub-options input[type="radio"] {
        appearance: none;
        border: 2px solid #007A33;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        position: relative;
        margin: 0;
      }
      
      .sub-options input[type="radio"]:checked::before {
        content: "";
        position: absolute;
        background: #007A33;
        border-radius: 50%;
        width: 8px;
        height: 8px;
        top: 3px;
        left: 3px;
      }
      
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex; /* Para centrar el contenido */
        justify-content: center; /* Centrado horizontal */
        align-items: center; /* Centrado vertical */
        z-index: 1000;
      }
      
      .modal-content {  
        text-align: center; /* centra el texto y botones dentro */
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 80%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      #resultado table {
        width: 100%;
        font-family: Arial, sans-serif;
        font-size: 14px;
        margin-top: 1rem;
        border: 1px solid #ccc;  
        border-collapse: collapse;        
      }
      
      #resultado td {
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
        border-bottom: 1px solid #eee;
        background-color: #ffffff;
      }
      #resultado th {
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
        border-bottom: 1px solid #eee;
        background-color: #f5f5f5;
      }
      
      #resultado.hidden {
        display: none;
      }
      
      .resultado-centrado {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      
      .hidden {
        display: none;
      }
      
      .panel-sugerencias {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.6s ease;
        background-color: #f5f5f5;
      }
      
      .panel-sugerencias.visible {
        max-height: 700px; /* suficiente para mostrar todo */
      }
      
      .sugerencias-grid {
        display: flex;
        gap: 0px;
        max-width: 900px;
        margin: 0 auto 30px;
      }
      
      .sugerencias-grid label input[type="checkbox"]:disabled + span,
      .sugerencias-grid label input[type="checkbox"]:disabled {
        filter: grayscale(100%);
        cursor: not-allowed;
      }
      
      .sugerencias-grid label.disabled {
        color: #999999;
        cursor: not-allowed;
      }
      
      .columna-izq {
        flex: 1.5;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .columna-der {
        flex: 1.2;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .footer-logo {
        position: fixed;
        bottom: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 15px;
      }
      
      .footer-logo .logo-text {
        font-size: 14px;
        font-weight: bold;
        color: #007A33;
        left: 0;
      }
      
      .footer-logo img {
        height: 70px;
      }
      
      .footer-datos {
        position: fixed;
        bottom: 0;
        right: 0;
        background-color: #f5f5f5;
        color: #007A33;
        font-size: 14px;
        text-align: right;
        padding: 10px 15px;
        border-top-left-radius: 8px;
        box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
      }
      #botonera {
        position: absolute;/* position: fixed; */
        top: 10px;
        right: 10px;
        z-index: 1000; /* Asegura que est√© por encima de otros elementos */
      }
      #inicio {  
        top: 10px;
        right: 10px;
      }
      #ayuda {
        top: 70px;
        right: 10px;
      }
      #avatarFlotante {
        background: transparent !important;  
        position: absolute;   /* relativo al contenedor (o body si no hay otro posicionado) */
        top: 100px;             /* centrado vertical, antes top: 100px;*/
        left: 50px;           /* pegado al borde izquierdo, antes 50px*/
        width: 300px;
        height: 400px;
        overflow: visible;
        z-index: 10;  
        transform-origin: top left;
        /*transition: transform 0.6s ease;*/
        /* A√ëADIR transiciones para top y left aqu√≠  */
        transition:
          top    0.6s ease-out,
          left   0.6s ease-out,
          transform 0.5s ease-out;
        /* Hint de rendimiento para GPU */
        will-change: top, left, transform;
      }
      canvas {
        background: transparent !important;
      }
      #live2dCanvas {
        width: 100% !important;
        height: 100% !important;
        background: transparent !important;
        display: block;
      }
      #textoAvatar {
        position: absolute;
        top: 275px; /* justo debajo del canvas (400px de alto + margen) */
        left: 0px;
        background-color: #DFE8DF; /* Fondo claro */
        color: #000;            /* Texto negro */
        padding: 10px;
        border-radius: 10px;
        font-size: 1em;
        max-width: 300px;
        z-index: 10;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3); /* Sombra para profundidad */
        display: block;
        visibility: visible;
        max-height: 400px; /* o el alto que uses normalmente */
        transition: max-height 0.5s ease, opacity 0.5s ease; 
      }
      #textoAvatar::after {
        content: "|";
        animation: blink 1s infinite;
      }
      
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }
      @keyframes entradaAvatar {
        0% {
          opacity: 0;
          transform: translateY(30px) scale(0.75);/* 0.95 */
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .avatar-animado {
        animation: entradaAvatar 0.6s ease-out;
      }
      @keyframes entradaRebote {
        0% {
          opacity: 0;
          transform: scale(0.3);
        }
        60% {
          opacity: 1;
          transform: scale(1.1);
        }
        80% {
          transform: scale(0.85);
        }
        100% {
          transform: scale(1);
        }
      }
      
      .avatar-rebote {
        animation: entradaRebote 0.6s ease-out;
      }
      .botonRespuesta {
        margin: 10px 5px;
        padding: 8px 16px;
        font-size: 1em;
        border: none;
        border-radius: 8px;
        background-color: #0078D4;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      
      .botonRespuesta:hover {
        background-color: #005a9e;
      }
      .burbujaRespuesta {
        position: absolute;
        padding: 12px 20px;
        border-radius: 30px;
        background-color: #007A33;
        color: white;
        font-size: 1em;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: flotarBurbuja 0.6s ease-out;
        transition: transform 0.3s, background-color 0.3s;
        z-index: 10;
      }
      
      .burbujaRespuesta:hover {
        background-color: #005e29;
        transform: scale(1.05);
      }
      
      @keyframes flotarBurbuja {
        0% {
          opacity: 0;
          transform: scale(0.5) translateY(20px);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      
      #formulario_No_Comunitario {
        text-align: center; /* centra el texto y botones dentro */
        background: #f9f9f9;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      #pagina_inicial {
        text-align: center; /* centra el texto y botones dentro */
        background: #f9f9f9;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      #Doc_Necesaria_Comunitario {
        text-align: center; /* centra el texto y botones dentro */
        background: #f9f9f9;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      #mensaje-aclaratorio {
        text-align: center; /* centra el texto y botones dentro */
        background: #f9f9f9;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      #manual {
        text-align: center; /* centra el texto y botones dentro */
        background: #f9f9f9;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      #formulario {
        text-align: center; /* centra el texto y botones dentro */
        background: #f9f9f9;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .ocultoSuave {
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.4s ease, transform 0.4s ease;
        pointer-events: none;
        height: 0;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .ocultoDeslizado {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.5s ease, opacity 0.5s ease;
      }
      
      /* 1) Define la animaci√≥n de pulso */
      @keyframes pulsoAvatar {
        0%, 100% {
          transform: scale(0.27);
        }
        50% {
          transform: scale(0.32);
        }
      }
      /* 2) Ajusta el origen de la transformaci√≥n al centro */
      #avatarFlotante.avatar-minimizado {
        transform-origin: top left; /* ‚Üê esto es clave para posicionar bien */
        transform: scale(0.30);        /* 300√ó0.2 = 60px, 400√ó0.2 = 80px */
        animation: pulsoAvatar 3.6s ease-in-out infinite;
      }
      
      .btn-principal {
        background-color:#007A33;
        color:white;
        font-size: 22px;
        padding: 18px 42px;
        width: 100%;
        max-width: 500px;
      }
      
      .btn-secundario {
        background-color:#007A33;
        font-size: 16px;
        padding: 12px 26px;
      }
      #modalInscrito h3 {
        margin-bottom: 20px;
        color:#007A33;
        line-height:1.3;
        font-size:20px;
      }
      
    </style>
  </head>
  <body>
    <!-- Dise√±o e idea original de la Direcci√≥n Provincial de Granada, en concreto de:
    Jefe de Servicio: Francisco Escabias Garc√≠a.
    Dise√±ador: Valent√≠n Jim√©nez Extremera.
    Contenido: Elisabeth Huertas Garc√≠a y Jos√© Manuel Robles Chaves.
    Testeo y verificaci√≥n: Isabel Pel√°ez Carmona, Silvia G√≥mez Mart√≠n, Inmaculada Ortega Avil√©s.
    Aporte de informaci√≥n: Todas las oficinas SAE de la provincia de Granada y sus direcciones de ATE. -->
    <!-----botones ir a inicio y ayuda--->
    <div id="botonera">
      <div id="inicio" class="nacionalidad-card">
        <button class="btn-small" onclick="volverInicio(); confirmarBorrado();">Inicio</button>
      </div>
      <div id="ayuda" class="nacionalidad-card">
        <button class="btn-small" onclick="ayuda();">Ayuda</button>
      </div>
    </div>
    
  <div id="pagina_inicial">
      <div id="titulo">
        <h1>Ayuda para el registro en SILA de una persona extranjera</h2>
        
        <!-------------------------Esto es temporal hasta elegir la voz para el avatar--------------------------------------------------------------->
        <label for="vozSelector">Elige la voz del avatar:</label>
        <select id="vozSelector"></select>
        <button id="btnEscucharMuestra">üîä Escuchar muestra</button>      
        
      </div>
      <!-- P√°gina de nacionalidad (ORIGEN) -->
      <div id="nacionalidad-page" class="nacionalidad-card">
        <h2>Selecciona el Origen de la persona usuaria</h2>
        <div class="botones-nacionalidad">
          <div class="btn-wrapper">
            <button class="btn btn-secundario" onclick="mostrarFormularioComunitario()">Comunitario/a</button>
            <span class="tooltip-container">
              <span class="help-icon">?</span>
              <div class="tooltip-text">
                <strong>Pa√≠ses comunitarios:</strong><br>
                  Austria, B√©lgica, Bulgaria, Chipre, Rep√∫blica Checa, Dinamarca, Estonia, Finlandia, Francia,
                  Alemania, Grecia, Hungr√≠a, Irlanda, Italia, Letonia, Lituania, Luxemburgo, Malta,
                  Pa√≠ses Bajos, Polonia, Portugal, Ruman√≠a, Eslovaquia, Eslovenia, Espa√±a, Suecia,
                  Islandia, Liechtenstein, Noruega, Suiza.
              </div>
            </span>
          </div>
          
          <button class="btn btn-principal" onclick="mostrarFormularioNoComunitario()">No Comunitario/a</button>
        
        </div>
      </div>
    </div>  <!-- fin pagina inicial -->
    
    <!-- Documentaci√≥n Necesaria para Comunitario -->
    <div id="Doc_Necesaria_Comunitario" class="hidden">
      <h2>Documentaci√≥n Necesaria para Inscribir a una persona Comunitaria</h2>
      <br>
      Documento acreditativo de identidad
      <br>
      Certificado de inscripci√≥n .....
      <br>
      Tarjeta Verde...
      <br>
      <br>
      <button class="btn-small" onclick="volverNacionalidad()">‚Üê Volver</button>
    </div>

    <!-- Formulario completo -->
    <div id="formulario" class="hidden">
      <div class="card">
        <!-- Campo de b√∫squeda -->
        <div class="search-container">
          <textarea id="search-box" placeholder="Copia aqu√≠ los conceptos clave..." rows="4" onfocus="preguntarBorrado(event)" spellcheck="true" lang="es"></textarea> 
        </div>

        <!-- Bot√≥n de buscar -->
        <div class="button-container">
          <button id="buscarBtn" onclick="ocultar_resultado();">Buscar</button>
        </div>
        <div id="loader" style="display:none; text-align:center; margin:10px;">
          <span>üîÑ Buscando... por favor, espera</span>
        </div>

        <div id="resultado" class="hidden"></div>

        <div id="sugerenciasPanel" class="panel-sugerencias hidden">
          <h3 style="text-align:center;">Selecciona uno o m√°s conceptos clave:</h3>
          <form id="sugerenciasForm" class="sugerencias-grid"></form>
          <div style="text-align: center;">
            <button class="btn" onclick="buscarDesdeSugerencias()">Buscar con selecci√≥n</button>
            <button class="btn-small" onclick="ocultarSugerencias()">‚Üê Ocultar</button>
          </div>
        </div>

        <!-- Bot√≥n de volver -->
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn-small" onclick="volverInicioDesdeFormulario(); confirmarBorrado();">‚Üê Volver</button>
        </div>
      </div>
    </div>

    <!-- Modal personalizado ALERTA-->
    <div id="mi-modal" class="hidden modal">
      <div class="modal-content">
        <p id="modal-texto"></p>
        <button class="btn" onclick="cerrarModal()">Cerrar</button>
      </div>
    </div>

    <!-- Modal para confirmar borrado -->
    <div id="modal-borrar" class="hidden modal">
      <div class="modal-content">
        <p>¬øDeseas borrar el contenido actual?</p>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn" onclick="confirmarBorrado()">S√≠, borrar</button>
          <button class="btn-small" onclick="cerrarModalBorrar()">No, modificar</button>
        </div>
      </div>
    </div>

    <!-- MODAL PREGUNTA INSCRITO -->
    <div id="modalInscrito" class="modal hidden">
      <div class="modal-content">
        <h3>Tras consultar SILA<br>¬øest√° actualmente inscrita esta persona?</h3>
        <button class="btn" style="width:100%; margin-top:14px;" onclick="guardarEstado('SI')">S√≠</button>
        <button class="btn" style="width:100%; margin-top:14px;" onclick="guardarEstado('NO')">No</button>
      </div>
    </div>
    
    <!-- Pie de p√°gina fijo -->
    <footer>
      <div class="footer-logo">
        <div class="logo-text">Direcci√≥n Provincial de Granada</div>
        <img src="/SituacionesAdministrativas/images/SAE_Junta_de_Andalucia_Documentacion.png" alt="Logo Junta de Andaluc√≠a" />
      </div>
      <div class="footer-datos">
        <b>Apoyo durante la fase de testeo para la resoluci√≥n de dudas y la recogida de incidencias:</b><br>
        <hr>
        Versi√≥n 4.0<br>
        Elisabeth Huertas Garc√≠a &lt;<a href="mailto:elisabeth.huertas.garcia@juntadeandalucia.es">elisabeth.huertas.garcia@juntadeandalucia.es</a>&gt; ‚Äì 765145<br>
        Jos√© Manuel Robles Chaves &lt;<a href="mailto:josem.robles@juntadeandalucia.es">josem.robles@juntadeandalucia.es</a>&gt; ‚Äì 653467
      </div>
    </footer>
    <script>
      // Obtener la voz deseada
      let vozElegida = null;
      window.speechSynthesis.onvoiceschanged = () => {
        const voces = speechSynthesis.getVoices();
        vozElegida = voces.find(v => v.name.includes("Pablo") && v.lang.includes === "ES");
      };
      let vozSeleccionada = null;
      
      function cargarVoces() {
        const selector = document.getElementById("vozSelector");
        selector.innerHTML = ""; // Limpiar opciones previas
      
        const voces = speechSynthesis.getVoices().filter(v => v.lang === "es-ES");
      
        voces.forEach(voz => {
          const opcion = document.createElement("option");
          opcion.value = voz.name;
          opcion.textContent = voz.name;
          selector.appendChild(opcion);
        });
      
        // Si hay una voz guardada en localStorage, seleccionarla
        const guardada = localStorage.getItem("vozAvatar");
        if (guardada) {
          selector.value = guardada;
          vozSeleccionada = voces.find(v => v.name === guardada);
        } else {
          vozSeleccionada = voces[3]; // Por defecto, la primera
        }
      
        selector.addEventListener("change", () => {
          vozSeleccionada = voces.find(v => v.name === selector.value);
          localStorage.setItem("vozAvatar", selector.value);
        });
      }
      
      // Esperar a que las voces est√©n disponibles
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = cargarVoces;
      }
      document.getElementById("btnEscucharMuestra").addEventListener("click", () => {
        const muestra = new SpeechSynthesisUtterance("Hola, soy tu gu√≠a virtual. ¬øMe escuchas bien?. ¬°Perfecto!.");
        muestra.lang = "es-ES";
      
        if (vozSeleccionada) {
          muestra.voice = vozSeleccionada;
        }
      
        window.speechSynthesis.speak(muestra);
      });
      document.addEventListener("DOMContentLoaded", () => {
        cargarVoces(); // ‚úÖ Ejecutar directamente al cargar
      });
      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxigLGGauWCphFL95VD5R0mWm5mM65_wuq5KhwWxyZmM8I8h5pJQ-nKzJ5u6DqpNJTvaw/exec";
      function ayuda() {
        detenerHablaAvatar(); // ‚úÖ detener habla al pulsar
        window.open("https://www.tupagina.com", "_blank");
      }
      
      function actualizarDisponibles() {
        const checkboxes = Array.from(document.querySelectorAll('#sugerenciasForm input[type="checkbox"]'));
        const labels = Array.from(document.querySelectorAll('#sugerenciasForm label'));
      
        // Seleccionados actualmente (checkbox checked)
        const seleccionados = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
      
        // Si no hay seleccionados, activar todo y quitar clase disabled
        if (seleccionados.length === 0) {
          checkboxes.forEach(cb => {
            cb.disabled = false;
          });
          labels.forEach(label => {
            label.classList.remove('disabled');
          });
          return;
        }
      
        // Funci√≥n para comprobar si una combinaci√≥n v√°lida contiene TODOS los seleccionados + candidato
        // Queremos que al marcar otro, la combinaci√≥n sea una superconjunto de los seleccionados actuales + ese candidato
        function esCompatible(candidato) {
          // Por cada combinaci√≥n v√°lida
          return combinacionesValidas.some(comb => {
            // La combinaci√≥n debe contener al candidato
            if (!comb.includes(candidato)) return false;
      
            // Y debe contener todos los seleccionados
            return seleccionados.every(sel => comb.includes(sel));
          });
        }
      
        // Recorremos todos checkboxes y deshabilitamos si no es compatible
        checkboxes.forEach(cb => {
          if (seleccionados.includes(cb.value)) {
            // Checkbox seleccionado: siempre habilitado
            cb.disabled = false;
            cb.parentElement.classList.remove('disabled');
          } else {
            // No seleccionado: habilitar solo si es compatible con la selecci√≥n
            if (esCompatible(cb.value)) {
              cb.disabled = false;
              cb.parentElement.classList.remove('disabled');
            } else {
              cb.disabled = true;
              cb.parentElement.classList.add('disabled');
            }
          }
        });
      }
      
      // A√±adir evento a cada checkbox para actualizar al cambiar
      function anadirEventosCheck() {
        const checkboxes = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.addEventListener('change', actualizarDisponibles);
        });
      }
      
      // En tu funci√≥n mostrarSugerencias, tras crear el formulario, llama a a√±adirEventosCheck()
      
      function ocultar_resultado(){
        document.getElementById('resultado').classList.add('hidden');
      }
      
      function preguntarBorrado() {
        const textarea = document.getElementById('search-box');
      
        // Si el modal ya est√° abierto, no hacer nada
        const modalVisible = !document.getElementById('modal-borrar').classList.contains('hidden');
        if (modalVisible) return;
      
        // Si hay texto, mostrar el modal
        if (textarea.value.trim() !== '') {
          textarea.blur(); // Para evitar escribir mientras responde
          document.getElementById('modal-borrar').classList.remove('hidden');
        }
      }
      function confirmarBorrado() {
        const textarea = document.getElementById('search-box');
        textarea.value = '';
        cerrarModalBorrar();
      }
      
      function cerrarModalBorrar() {
        document.getElementById('search-box').focus();
        document.getElementById('modal-borrar').classList.add('hidden');
        document.getElementById('resultado').classList.add('hidden');
      }
      
      const urls = {
        "TIE": "/SituacionesAdministrativas/images/TIE.png",
        "Documento": "/SituacionesAdministrativas/images/resolucion.png",
        "Tarjeta Roja": "/SituacionesAdministrativas/images/Tarjeta_roja.png"
      };
      
      const conceptosClave = [
        "Art 50 TUE. Retirada Reino Unido",
        "Asilo / Ap√°trida / Desplazados o protecci√≥n internacional",
        "Circunstancias excepcionales",
        "Estudio, pr√°cticas o voluntariado",
        "Familiar de ciudadano de UE",
        "Ley 14/2013",
        "Menores",
        "Reagrupaci√≥n familiar",
        "Residencia temporal que Autoriza a trabajar",
        "Residencia temporal que No Autoriza a trabajar",
        "Residencia Larga Duraci√≥n",
        "Permiso de Residencia y Trabajo",
        "Visado b√∫squeda empleo",
        "Prestaci√≥n sin autorizaci√≥n laboral"
      ];
      
      const combinacionesValidas = [
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia temporal que Autoriza a trabajar"],
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia temporal que No Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que No Autoriza a trabajar"],        
        ["Residencia Larga Duraci√≥n", "Permiso de Residencia y Trabajo"],
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia Larga Duraci√≥n", "Permiso de Residencia y Trabajo"]
      ];
            
      function mostrarModal(mensaje) {
        document.getElementById("modal-texto").textContent = mensaje;
        document.getElementById("mi-modal").classList.remove("hidden");
      }
      
      function cerrarModal() {
        document.getElementById("mi-modal").classList.add("hidden");
      }
      
      function mostrarFormularioComunitario() {
        document.getElementById("pagina_inicial").classList.add("hidden");
        document.getElementById("Doc_Necesaria_Comunitario").classList.remove("hidden");
      }      
      
      function mostrarFormulario() {
        detenerHablaAvatar(); // ‚úÖ detener habla al pulsar
        document.getElementById("manual").classList.add("hidden");
        document.getElementById("formulario").classList.remove("hidden");
      }
      function volverInicioDesdeFormulario() {
        document.getElementById("search-box").value = "";
        document.getElementById("formulario").classList.add("hidden");
        document.getElementById("manual").classList.remove("hidden");
        document.getElementById("buscarBtn").classList.remove("hidden");
      }
      function volverInicio() {
        detenerHablaAvatar(); // ‚úÖ detener habla al pulsar
        document.getElementById("pagina_inicial").classList.remove("hidden");
        document.getElementById("formulario").classList.add("hidden");
        document.getElementById("manual").classList.add("hidden");
        document.getElementById("Doc_Necesaria_Comunitario").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.add("hidden");
        document.getElementById("manual").classList.add("hidden");  
        document.getElementById("mensaje-aclaratorio").classList.add("hidden");  
      }
      function volverNacionalidad() {
        document.getElementById("Doc_Necesaria_Comunitario").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.add("hidden");
        document.getElementById("pagina_inicial").classList.remove("hidden");
      }
      
      function volverNoComunitario() {
        detenerHablaAvatar(); // ‚úÖ detener habla al pulsar
        document.getElementById("manual").classList.add("hidden");  
        document.getElementById("mensaje-aclaratorio").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.remove("hidden");
        document.getElementById("avatarFlotante").classList.add("hidden");
      }
      
      function mostrarResultado(data) {
        const contenedor = document.getElementById("resultado");
        contenedor.innerHTML = ""; // Limpiar resultados anteriores
      
        if (!data || data.length === 0) {
          const ayuda = document.createElement("p");
          ayuda.innerHTML = `
            <p style="text-align: center;">No se encontr√≥ nada. Si necesitas ayuda, puedes clicar en: 
            <button class="btn-small" onclick="mostrarSugerencias()">Mostrar sugerencias</button></p>
          `;
          contenedor.appendChild(ayuda);
          return;
        }
      
        // Crear tabla
        const tabla = document.createElement("table");
      
        // Cabecera
        tabla.innerHTML = `
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Autorizaci√≥n</th>
              <th>Modalidad</th>
              <th>Observaciones</th>
              <th>Documentaci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
      
        const cuerpo = tabla.querySelector("tbody");
      
        // Filas
        data.forEach(item => {
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${item.codigo || ""}</td>
            <td>${(item.autoriza || "").replace(/\n/g, "<br>")}</td>
            <td>${(item.modalidad || "").replace(/\n/g, "<br>")}</td>
            <td>${(item.observaciones || "").replace(/\n/g, "<br>")}</td>
            <td> ${item.documento
                ? `<a href="${item.documento}" target="_blank" rel="noopener noreferrer">Ver PDF</a>`
                : "No disponible"}
            </td>
      
          `;
          cuerpo.appendChild(fila);
        });
      
        contenedor.appendChild(tabla);
      }
      
      
      function mostrarSugerencias() {
        const panel = document.getElementById("sugerenciasPanel");
        const form = document.getElementById("sugerenciasForm");
      
        // Mostrar el panel con animaci√≥n (quita clase hidden y a√±ade visible con delay)
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("visible"), 100);
      
        // Dividir conceptos en dos columnas de 7 elementos
        const primeraColumna = conceptosClave.slice(0, 7);
        const segundaColumna = conceptosClave.slice(7, 14);
      
        // Crear contenido HTML para ambas columnas dentro del formulario
        const col1HTML = primeraColumna.map(c =>
          `<label><input type="checkbox" name="concepto" value="${c}"> ${c}</label>`
        ).join("");
      
        const col2HTML = segundaColumna.map(c =>
          `<label><input type="checkbox" name="concepto" value="${c}"> ${c}</label>`
        ).join("");
      
        // Insertar el contenido en el formulario (sugerenciasForm)
        form.innerHTML = `
          <div class="columna-izq">${col1HTML}</div>
          <div class="columna-der">${col2HTML}</div>
        `;
        anadirEventosCheck();
        actualizarDisponibles();  
      }
      
      function ocultarSugerencias() {
        const panel = document.getElementById("sugerenciasPanel");
        panel.classList.remove("visible");
        setTimeout(() => panel.classList.add("hidden"), 600);
      }
      
      function mostrarAyudaConceptos() {
        const container = document.getElementById("resultado");
        const lista = conceptosClave.map(c => `<li>${c}</li>`).join("");
        container.innerHTML = `
          <h3 style="color: #007A33;">Conceptos que puedes utilizar:</h3>
          <ul style="text-align: left; max-width: 700px; margin: 20px auto; font-size: 16px; line-height: 1.6;">
            ${lista}
          </ul>
          <div style="text-align: center; margin-top: 20px;">
            <button class="btn-small" onclick="document.getElementById('resultado').classList.add('hidden');">‚Üê Ocultar ayuda</button>
          </div>`;
      }
      
      
      // üîé Nueva funci√≥n buscar()
      async function buscar() {
      const searchText = document.getElementById("search-box").value.trim();
      const opcionesMarcadas = []; // si usas checkboxes en sugerencias, aqu√≠ se pasan
      
      if (!searchText) {
        mostrarModal("Por favor, introduce un texto para buscar.");
        return;
      }
      
      document.getElementById("loader").style.display = "block";
      document.getElementById("resultado").classList.add("hidden");
      
      try {
        const response = await fetch(WEBAPP_URL, {
          method: "POST",
          body: JSON.stringify({ searchText, opcionesMarcadas })
        });
      
        if (!response.ok) throw new Error("Error en la petici√≥n");
      
        const data = await response.json();
        mostrarResultado(data);
      
      } catch (err) {
        console.error(err);
        mostrarModal("Error al conectar con el servidor.");
      } finally {
        document.getElementById("loader").style.display = "none";
        document.getElementById("resultado").classList.remove("hidden");
      }
      }
      
      // Reemplazamos onclick del bot√≥n Buscar
      document.getElementById("buscarBtn").onclick = () => {
      ocultar_resultado();
      buscar();
      };
      
      // Modificamos buscarDesdeSugerencias()
      function buscarDesdeSugerencias() {
      const checkboxes = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]:checked');
      const seleccionados = Array.from(checkboxes).map(cb => cb.value);
      
      if (seleccionados.length === 0) {
        alert("Debes seleccionar al menos un concepto.");
        return;
      }
      
      let conceptoBusqueda = null;
      
      if (seleccionados.length === 1) {
        conceptoBusqueda = seleccionados[0];
      } else {
        for (const combinacion of combinacionesValidas) {
          const esSubconjunto = seleccionados.every(sel => combinacion.includes(sel));
          if (esSubconjunto) {
            conceptoBusqueda = combinacion[0];
            break;
          }
        }
        if (!conceptoBusqueda) {
          alert("La combinaci√≥n seleccionada no es v√°lida.");
          return;
        }
      }
      
      document.getElementById("search-box").value = conceptoBusqueda;
      buscar();
      ocultarSugerencias();
      }
      
      let estadoInscrito = "";  // se usar√° luego en el filtro
      
      function mostrarFormularioNoComunitario() {
        document.getElementById("modalInscrito").classList.remove("hidden");
      }
      
      function guardarEstado(valor) {
        estadoInscrito = valor;          // guarda si o no
        document.getElementById("modalInscrito").classList.add("hidden");
        mostrarFormularioBusqueda();     // y ahora abrimos buscador
      }
      
      // esta funci√≥n ya la tendr√°s‚Ä¶ solo aseg√∫rate que existe
      function mostrarFormularioBusqueda() {
        document.getElementById("pagina_inicial").classList.add("hidden");
        document.getElementById("formulario").classList.remove("hidden");
      }      
    </script>
  </body>
</html>
