<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ASIM-SAE — Aplicación de soporte para la inscripción de migrantes</title>
  <style>
    :root{
      --sae-green:#007A33;
      --muted:#6b6b6b;
      --card-bg:#fff;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
    }
    html,body{height:100%;margin:0;background:#f5f5f5}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;padding:8px 0}
    header img{height:60px}
    header h1{margin:0;color:var(--sae-green);font-size:20px}
    header h2{margin:0;font-size:14px;color:var(--muted)}

    /* layout principal */
    .search-container {
      display:flex;
      flex-direction:column;
      align-items:center;
      margin: 30px auto;
      width:100%;
      max-width:820px;
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .search-intro { text-align:left; width:100%; margin-bottom:12px; font-size:1rem; color:#222; }
    .filters { display:flex; gap:18px; width:100%; justify-content:flex-start; flex-wrap:wrap; margin-bottom:14px; }
    .filters label { display:flex; align-items:center; gap:8px; font-size:0.95rem; color:#222; }
    .filters input[type="checkbox"]{ width:16px; height:16px; }

    /* área búsqueda */
    #searchArea{ width:100%; display:flex; flex-direction:column; gap:10px }
    .search-top{ display:flex; gap:10px; align-items:center }
    .search-top input{ flex:1; padding:12px 14px; border-radius:8px; border:1px solid #dfeee0; font-size:16px }
    .search-top button{ padding:11px 18px; border-radius:8px; border:none; background:var(--sae-green); color:#fff; font-weight:600; cursor:pointer }
    .search-top button[disabled]{ opacity:0.5; cursor:not-allowed }
    .search-meta{ display:flex; justify-content:space-between; color:var(--muted); font-size:13px; }
    .results{ margin-top:8px }
    .result-item{ display:flex; gap:12px; padding:10px; border-radius:8px; border:1px solid #e6efe7; background:#fff; margin-bottom:8px; cursor:pointer }
    .result-item h3{ margin:0;font-size:15px }
    .result-item p{ margin:6px 0 0;color:var(--muted);font-size:13px }

    /* modal detalle (simple) */
    .modal-backdrop{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:9999 }
    .modal{ background:var(--card-bg); border-radius:10px; padding:0; width:90%; max-width:720px; max-height:80vh; overflow:auto; box-shadow:0 20px 40px rgba(0,0,0,0.25) }
    .modal-header-sae{ background:var(--sae-green); color:#fff; padding:14px 18px; border-top-left-radius:10px; border-top-right-radius:10px }
    .modal-body-sae{ padding:16px 18px }
    .actions{ display:flex; gap:10px; justify-content:center; padding:12px }

    .no-data{ color:var(--muted); font-style:italic }
    @media (max-width:600px){ .filters{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="/SituacionesAdministrativas/images/SAE_Junta_de_Andalucia_Documentacion.png" alt="Logo">
      <div>
        <h1>ASIM-SAE</h1>
        <h2>Aplicación de soporte para la inscripción de migrantes</h2>
      </div>
    </header>

    <div class="search-container" role="region" aria-labelledby="intro">
      <div id="intro" class="search-intro">
        <p><strong>Consulta SILA y marca lo que corresponda:</strong></p>
      </div>

      <div class="filters" aria-label="Opciones SILA">
        <!-- IDs y nombres que usa el script -->
        <label><input type="checkbox" id="chkInscrito"> Consta una inscripción previa en SILA</label>
        <label><input type="checkbox" id="chkPrestacion"> Cobra prestación o subsidio</label>
        <label><input type="checkbox" id="chkNada"> Nada de lo anterior</label>
      </div>

      <!-- Área de búsqueda -->
      <div id="searchArea" aria-live="polite">
        <div class="search-top">
          <input id="searchInput" type="text" placeholder="Buscar por palabras…" aria-label="Buscar por palabras" disabled>
          <button id="btnSearch" disabled>Buscar</button>
        </div>

        <div class="search-meta">
          <span class="small">Opciones marcadas: <span id="estadoChecks" class="small no-data">ninguna</span></span>
          <span class="small">Resultados: <span id="countResults">0</span></span>
        </div>

        <div class="results" id="results" aria-live="polite"></div>
      </div>
    </div>

    <!-- modal detalle -->
    <div id="modalDetalle" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal" role="document">
        <div class="modal-header-sae"><h3 id="modalDetalleTitulo">Detalles del registro</h3></div>
        <div class="modal-body-sae" id="modalDetalleContent"></div>
        <div class="actions">
          <button id="btnVolverDetalle" class="btn">Volver</button>
          <button id="btnCerrarDetalle" class="btn" style="background:#b71c1c;color:#fff">Cerrar</button>
        </div>
      </div>
    </div>

    <footer style="margin-top:18px;color:var(--muted);font-size:13px">
      <div><b>Apoyo durante la fase de testeo:</b> Versión 5.01 — Dirección Provincial de Granada</div>
    </footer>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // elements
  const chkInscrito = document.getElementById('chkInscrito');
  const chkPrestacion = document.getElementById('chkPrestacion');
  const chkNada = document.getElementById('chkNada');
  const estadoChecks = document.getElementById('estadoChecks');

  const searchInput = document.getElementById('searchInput');
  const btnSearch = document.getElementById('btnSearch');
  const resultsEl = document.getElementById('results');
  const countResults = document.getElementById('countResults');

  const modalDetalle = document.getElementById('modalDetalle');
  const modalDetalleContent = document.getElementById('modalDetalleContent');
  const btnVolverDetalle = document.getElementById('btnVolverDetalle');
  const btnCerrarDetalle = document.getElementById('btnCerrarDetalle');

  let db = [];

  // comportamiento: si se marca 'Nada de lo anterior' se desmarcan los otros; si se marcan otros se desmarca 'Nada'
  function syncNadaLogic(changed) {
    if (changed === 'nada' && chkNada.checked) {
      chkInscrito.checked = false;
      chkPrestacion.checked = false;
    }
    if ((changed === 'inscrito' || changed === 'prestacion') && (chkInscrito.checked || chkPrestacion.checked)) {
      chkNada.checked = false;
    }
  }

  function actualizarChecks() {
    syncNadaLogic(); // aplica la lógica de exclusividad

    const activos = [];
    if (chkInscrito.checked) activos.push('Consta inscripción previa en SILA');
    if (chkPrestacion.checked) activos.push('Cobra prestación o subsidio');
    if (chkNada.checked) activos.push('Nada de lo anterior');

    if (activos.length > 0) {
      estadoChecks.textContent = activos.join(', ');
      estadoChecks.classList.remove('no-data');
      searchInput.disabled = false;
      btnSearch.disabled = false;
      // limpiamos campo/resultados anteriores para forzar búsqueda nueva
      searchInput.value = '';
      resultsEl.innerHTML = '';
      countResults.textContent = '0';
    } else {
      estadoChecks.textContent = 'ninguna';
      estadoChecks.classList.add('no-data');
      searchInput.disabled = true;
      btnSearch.disabled = true;
      searchInput.value = '';
      resultsEl.innerHTML = '';
      countResults.textContent = '0';
    }
  }

  // listeners
  chkInscrito.addEventListener('change', ()=>{ syncNadaLogic('inscrito'); actualizarChecks(); });
  chkPrestacion.addEventListener('change', ()=>{ syncNadaLogic('prestacion'); actualizarChecks(); });
  chkNada.addEventListener('change', ()=>{ syncNadaLogic('nada'); actualizarChecks(); });

  // JSON load (una sola vez)
  async function loadJSON(){
    try{
      const res = await fetch('./SituacionesAdministrativas.json', {cache:'no-store'});
      if(!res.ok) throw new Error('No se pudo cargar SituacionesAdministrativas.json');
      db = await res.json();
      console.log('Registros cargados:', db.length);
    }catch(err){
      console.error(err);
      resultsEl.innerHTML = `<div class="small" style="color:#c62828">Error al cargar JSON: ${err.message}</div>`;
    }
  }
  loadJSON();

  // búsqueda (usa ANVERSO y REVERSO solamente)
  function normalize(s){
    if(s==null) return '';
    return String(s).normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\p{L}\p{N}]+/gu,' ').toLowerCase().trim();
  }

  function tokenize(q){
    return normalize(q).split(/\s+/).filter(Boolean);
  }

  btnSearch.addEventListener('click', doSearch);
  searchInput.addEventListener('keydown', e => { if (e.key==='Enter') doSearch(); });

  function doSearch(){
    resultsEl.innerHTML = '';
    const q = searchInput.value.trim();
    if(!q){ resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>'; countResults.textContent='0'; return; }

    const tokens = tokenize(q);
    if(tokens.length===0){ resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>'; countResults.textContent='0'; return; }

    const matches = [];

    db.forEach((rec, idx) => {
      const anverso = normalize(rec['ANVERSO']||'');
      const reverso = normalize(rec['REVERSO']||'');
      const combined = `${anverso} ${reverso}`.trim();

      // buscar tokens como palabras (evitar falsos positivos en "no autoriza" vs "autoriza")
      let presentCount = 0;
      tokens.forEach(tok => {
        if(tok === 'autoriza'){
          // autoriza sólo si aparece como palabra y NO forma parte de 'no autoriza'
          if(/\bautoriza\b/.test(combined) && !/\bno\s+autoriza\b/.test(combined)) presentCount++;
        } else if(tok === 'no' && tokens.includes('autoriza')){
          // esto ya estaría combinado si el usuario escribió "no autoriza" como tokens separados;
          // mejor comportamiento es permitir que tokenize fusione 'no autoriza' si lo escribe tal cual,
          // pero dejamos cobertura por si no se combinó
          if(/\bno\s+autoriza\b/.test(combined)) presentCount++;
        } else {
          // coincidencia simple por palabra
          const re = new RegExp('\\b' + tok.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\b','u');
          if(re.test(combined)) presentCount++;
        }
      });

      if(tokens.length>0 && (presentCount / tokens.length) >= 0.75){
        matches.push({rec, idx});
      }
    });

    if(matches.length===0){
      resultsEl.innerHTML = '<div class="small">No se han encontrado registros con el filtro aplicado.</div>';
      countResults.textContent='0';
      return;
    }

    countResults.textContent = String(matches.length);
    matches.forEach(m=>{
      const rec = m.rec;
      const wrapper = document.createElement('div');
      wrapper.className = 'result-item';
      const title = document.createElement('h3');
      title.textContent = (rec['ANVERSO']||'').substring(0,120);
      const p = document.createElement('p');
      p.textContent = (rec['REVERSO']||'').substring(0,220);
      wrapper.appendChild(title); wrapper.appendChild(p);
      wrapper.addEventListener('click', ()=> openModalDetalle(rec));
      resultsEl.appendChild(wrapper);
    });
  }

  function openModalDetalle(rec){
    modalDetalleContent.innerHTML = `
      <div class="field"><strong>Inscripción en SILA:</strong> ${rec["Inscripción en SILA"]||''}</div>
      <div class="field"><strong>¿Autoriza a Trabajar?</strong> ${rec["¿Autoriza a Trabajar?"]||''}</div>
      <div class="field"><strong>Tipo de Demanda:</strong> ${rec["Tipo de Demanda"]||''}</div>
      <div class="field"><strong>Observaciones:</strong> ${rec["Observaciones"]||''}</div>
      <div class="field"><strong>Documentación:</strong> ${rec["Documentación"]?`<a href="${rec["Documentación"]}" target="_blank">Ver documento</a>`:''}</div>
    `;
    modalDetalle.style.display = 'flex';
    modalDetalle.setAttribute('aria-hidden','false');
  }

  function closeModalDetalle(){
    modalDetalle.style.display = 'none';
    modalDetalle.setAttribute('aria-hidden','true');
  }

  btnVolverDetalle.addEventListener('click', ()=>{ closeModalDetalle(); });
  btnCerrarDetalle.addEventListener('click', ()=>{ closeModalDetalle(); });

  // inicio: dejar todo limpio (checkboxes sin marcar)
  actualizarChecks();
});
</script>
</body>
</html>

