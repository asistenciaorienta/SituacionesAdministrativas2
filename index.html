<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Apoyo SAE — Situaciones Administrativas</title>
  <style>
    :root{
      --sae-green:#2e7d32; /* verde institucional (ajustable) */
      --sae-green-dark:#1b5e20;
      --muted:#6b6b6b;
      --card-bg:#fff;
      --glass: rgba(255,255,255,0.9);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f3fbf5, #eef7ef);color:#0b2c2b}
    .container{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:72px;height:72px;object-fit:contain;border-radius:8px}
    h1{margin:0;font-size:20px;color:var(--sae-green-dark)}
    p.lead{margin:6px 0 0;color:var(--muted)}

    /* Botones principales */
    .cta-row{display:flex;gap:16px;margin:20px 0}
    .btn{padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(46,125,50,0.08)}
    .btn:active{transform:translateY(1px)}
    .btn-comunitario{background:transparent;color:var(--sae-green-dark);border:2px solid var(--sae-green);min-width:160px}
    .btn-nocomunitario{background:var(--sae-green);color:#fff;min-width:220px;font-size:18px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,18,10,0.45);display:none;align-items:center;justify-content:center;padding:20px}
    .modal{background:var(--card-bg);border-radius:12px;max-width:720px;width:100%;box-shadow:0 20px 40px rgba(0,0,0,0.15);padding:18px}
    .modal h2{margin:0 0 8px}
    .modal .muted{color:var(--muted);font-size:14px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}

    /* Search UI */
    .search-area{display:none;margin-top:18px;background:var(--glass);padding:16px;border-radius:10px}
    .search-row{display:flex;gap:10px;align-items:center}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #dfeee0}
    .small{font-size:13px;color:var(--muted)}

    /* Results */
    .results{margin-top:16px}
    .result-item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:8px;border:1px solid #e6efe7;background:white;margin-bottom:8px}
    .result-item .check{margin-top:2px}
    .result-item h3{margin:0;font-size:15px}
    .result-item p{margin:6px 0 0;color:var(--muted);font-size:13px}

    .details{margin-top:12px;padding:12px;border-radius:8px;background:#fff;border:1px solid #e6efe7}
    .field{display:flex;gap:8px;padding:6px 0}
    .field .label{width:180px;font-weight:600;color:var(--sae-green-dark);font-size:13px}
    .no-data{color:var(--muted);font-style:italic}

    footer{margin-top:22px;color:var(--muted);font-size:13px}

    /* Responsive */
    @media (max-width:600px){.cta-row{flex-direction:column}.btn-nocomunitario{min-width:unset;width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img class="logo" src="https://raw.githubusercontent.com/saempleo/assets/main/logo.png" alt="Logo SAE" onerror="this.style.display='none'">
      <div>
        <h1>Apoyo — Situaciones Administrativas</h1>
        <p class="lead">Herramienta auxiliar para personal técnico — busca en SituacionesAdministrativas.json</p>
      </div>
    </header>

    <div class="cta-row">
      <button id="btnComunitario" class="btn btn-comunitario">Comunitario</button>
      <button id="btnNoComunitario" class="btn btn-nocomunitario">No comunitario — Iniciar</button>
    </div>

    <!-- Modal Comunitario -->
    <div id="modalComunitarioBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <h2>Comunitario</h2>
        <p class="muted">texto de prueba, ya que todavía no está dedidido.</p>
        <div class="actions">
          <button id="closeComunitario" class="btn btn-comunitario">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal No Comunitario - pregunta SILA -->
    <div id="modalNoComunitarioBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>No comunitario</h2>
        <p class="muted">Antes de buscar: tras consultar SILA, ¿la persona está actualmente inscrita en SILA?</p>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="inscritoSi" class="btn" style="background:#fff;border:2px solid var(--sae-green);">Sí — Está inscrita</button>
          <button id="inscritoNo" class="btn" style="background:#fff;border:2px solid #c62828;color:#c62828">No — No está inscrita</button>
        </div>
        <div class="actions">
          <button id="closeNoComunitario" class="btn btn-comunitario">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Área de búsqueda -->
    <div id="searchArea" class="search-area" aria-live="polite">
      <div class="search-row">
        <input id="searchInput" type="text" placeholder="Busca por palabras (ej: moraleda de zafayona) — se buscan todas las palabras en ANVERSO y REVERSO">
        <button id="btnSearch" class="btn btn-nocomunitario">Buscar</button>
      </div>
      <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
        <div class="small">Filtro: respuesta a "¿Está inscrita actualmente en SILA?" — <span id="inscritoEstado" class="small no-data">no definido</span></div>
        <div style="margin-left:auto" class="small">Resultados: <span id="countResults">0</span></div>
      </div>

      <div class="results" id="results"></div>

      <div class="details" id="detailCard" style="display:none">
        <h3>Detalles del registro seleccionado</h3>
        <div id="detailFields"></div>
      </div>
    </div>

    <footer>Archivo JSON esperado: <strong>SituacionesAdministrativas.json</strong> (en la raíz del repositorio)</footer>
  </div>

  <script>
    // --- Utilidades para leer campos con posibles variantes de nombre ---
    function getField(obj, possibleNames){
      const keys = Object.keys(obj);
      for(const n of possibleNames){
        // normalizamos el nombre buscado
        const normN = n.trim().toLowerCase();
        for(const key of keys){
          if(key.trim().toLowerCase() === normN) return obj[key];
        }
      }
      return undefined;
    }

    // Elementos
    const btnComunitario = document.getElementById('btnComunitario');
    const modalComunitarioBackdrop = document.getElementById('modalComunitarioBackdrop');
    const closeComunitario = document.getElementById('closeComunitario');

    const btnNoComunitario = document.getElementById('btnNoComunitario');
    const modalNoComunitarioBackdrop = document.getElementById('modalNoComunitarioBackdrop');
    const closeNoComunitario = document.getElementById('closeNoComunitario');
    const inscritoSi = document.getElementById('inscritoSi');
    const inscritoNo = document.getElementById('inscritoNo');

    const searchArea = document.getElementById('searchArea');
    const searchInput = document.getElementById('searchInput');
    const btnSearch = document.getElementById('btnSearch');
    const resultsEl = document.getElementById('results');
    const countResults = document.getElementById('countResults');
    const inscritoEstado = document.getElementById('inscritoEstado');
    const detailCard = document.getElementById('detailCard');
    const detailFields = document.getElementById('detailFields');

    let db = [];
    let userInscritoAnswer = null; // 'SI' or 'NO'
    let selectedIndex = null;

    // Abrir modal comunitario
    btnComunitario.addEventListener('click',()=>{ modalComunitarioBackdrop.style.display='flex'; });
    closeComunitario.addEventListener('click',()=>{ modalComunitarioBackdrop.style.display='none'; });
    modalComunitarioBackdrop.addEventListener('click',(e)=>{ if(e.target===modalComunitarioBackdrop) modalComunitarioBackdrop.style.display='none'; });

    // No comunitario flow
    btnNoComunitario.addEventListener('click',()=>{ modalNoComunitarioBackdrop.style.display='flex'; });
    closeNoComunitario.addEventListener('click',()=>{ modalNoComunitarioBackdrop.style.display='none'; });
    modalNoComunitarioBackdrop.addEventListener('click',(e)=>{ if(e.target===modalNoComunitarioBackdrop) modalNoComunitarioBackdrop.style.display='none'; });

    inscritoSi.addEventListener('click',()=>{ setInscritoAnswer('SI'); modalNoComunitarioBackdrop.style.display='none'; openSearchArea(); });
    inscritoNo.addEventListener('click',()=>{ setInscritoAnswer('NO'); modalNoComunitarioBackdrop.style.display='none'; openSearchArea(); });

    function setInscritoAnswer(val){
      userInscritoAnswer = val;
      inscritoEstado.textContent = val === 'SI' ? 'Sí (técnico respondió: Sí)' : 'No (técnico respondió: No)';
      inscritoEstado.classList.remove('no-data');
    }

    function openSearchArea(){
      searchArea.style.display = 'block';
      // load data if not loaded
      if(db.length===0) loadJSON();
    }

    // Cargar JSON
    async function loadJSON(){
      try{
        const res = await fetch('./SituacionesAdministrativas.json', {cache:'no-store'});
        if(!res.ok) throw new Error('No se pudo cargar SituacionesAdministrativas.json — comprobar ruta/nombre y CORS');
        db = await res.json();
        console.log('Registros cargados:', db.length);
      }catch(err){
        console.error(err);
        resultsEl.innerHTML = `<div class="small" style="color:#c62828">Error al cargar SituacionesAdministrativas.json: ${err.message}</div>`;
      }
    }

    // Búsqueda — versión mejorada para evitar falsas negativas
    btnSearch.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') doSearch(); });

    function normalize(s){
      if(s==null) return '';
      return String(s)
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')         // quita tildes
        .replace(/[^\p{L}\p{N}]+/gu,' ')       // reemplaza todo lo que no sea letra/dígito por espacio
        .toLowerCase()
        .trim();
    }
    // lista corta de stopwords comunes en búsquedas que no aportan (artículos, preposiciones)
    const STOPWORDS = new Set(['a','la','el','los','las','de','del','y','o','en','por','para','con','sin','que','un','una','al','se','su','sus']);
    
    function doSearch(){
      resultsEl.innerHTML = '';
      detailCard.style.display='none';
      selectedIndex = null;
    
      const q = searchInput.value.trim();
      if(!q){ resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>'; countResults.textContent='0'; return; }
    
      const tokens = tokenizeQuery(q);
      if(tokens.length===0){ resultsEl.innerHTML = '<div class="small">Escribe una o varias palabras para buscar.</div>'; countResults.textContent='0'; return; }
    
      const fullQueryNormalized = normalize(q);
    
      const matches = [];
    
      db.forEach((rec, idx)=>{
        // aplicar filtro de '¿Inscrito anteriormente?' (campo puede tener variantes de nombre)
        const valInscritoAnterior = getField(rec, ['¿Inscrito anteriormente?', 'Inscrito anteriormente', 'INSCRITO ANTERIORMENTE', 'inscrito anteriormente']);
        const valInscritoAnteriorNormalized = valInscritoAnterior==null ? '' : String(valInscritoAnterior).trim().toUpperCase();
        const includeByInscrito = (valInscritoAnteriorNormalized === '') || (userInscritoAnswer && valInscritoAnteriorNormalized === userInscritoAnswer);
        if(!includeByInscrito) return;
    
        // combinar ANVERSO y REVERSO (normalizados)
        const anversoRaw = getField(rec, ['ANVERSO','Anverso','anverso']) || '';
        const reversoRaw = getField(rec, ['REVERSO',' Reverso',' Reverso',' REVERSO','Reverso','reverso']) || '';
        const anverso = normalize(anversoRaw);
        const reverso = normalize(reversoRaw);
        const combined = `${anverso} ${reverso}`.trim();
    
        // 1) si la query normalizada completa aparece como substring -> match
        if(fullQueryNormalized && combined.includes(fullQueryNormalized)){
          matches.push({rec, idx});
          return;
        }
    
        // 2) comprobar que todos los tokens relevantes estén presentes (pueden distribuirse entre anverso y reverso)
        const allPresent = tokens.every(tok => (anverso.includes(tok) || reverso.includes(tok) || combined.includes(tok)));
        if(allPresent) { matches.push({rec, idx}); return; }
    
        // 3) fallback: si está al menos el 75% de tokens -> match (tolerancia)
        let presentCount = 0;
        tokens.forEach(tok=>{ if(anverso.includes(tok) || reverso.includes(tok) || combined.includes(tok)) presentCount++; });
        if(tokens.length>0 && (presentCount / tokens.length) >= 0.75){ matches.push({rec, idx}); return; }
    
        // si no cumple ninguna, no coincide
      });
    
      if(matches.length===0){ resultsEl.innerHTML = '<div class="small">No se han encontrado registros que contengan todas las palabras en ANVERSO/REVERSO con el filtro aplicado.</div>'; countResults.textContent='0'; return; }
    
      // render matches
      countResults.textContent = String(matches.length);
      matches.forEach((m)=>{
        const rec = m.rec;
        const wrapper = document.createElement('div'); wrapper.className='result-item';
        const chkWrap = document.createElement('div'); chkWrap.className='check';
    
        const chk = document.createElement('input'); chk.type='checkbox'; chk.name='selectRec'; chk.dataset.index = m.idx;
        chk.addEventListener('change', onSelectRecord);
        chkWrap.appendChild(chk);
    
        const content = document.createElement('div'); content.style.flex='1';
        const title = document.createElement('h3');
        const anversoVal = anversoPreview(rec) || '';
        const reversoVal = getField(rec, ['REVERSO','Reverso','reverso']) || '';
        title.textContent = anversoVal ? anversoVal : (reversoVal ? reversoVal.substring(0,80) : 'Registro sin ANVERSO/REVERSO');
        const p = document.createElement('p'); p.textContent = (reversoVal ? reversoVal : '').substring(0,220);
        content.appendChild(title); content.appendChild(p);
    
        wrapper.appendChild(chkWrap); wrapper.appendChild(content);
        resultsEl.appendChild(wrapper);
      });
    }
    function tokenizeQuery(q){
      const norm = normalize(q);
      if(!norm) return [];
      const toks = Array.from(new Set(norm.split(/\s+/).filter(Boolean)));
      const filtered = toks.filter(t=>!STOPWORDS.has(t));
      return filtered.length>0 ? filtered : toks;
    }    
    function anversoPreview(rec){
      const av = getField(rec, ['ANVERSO','Anverso','anverso']) || '';
      return av.split('\\n')[0].substring(0,120);
    }
    
    function onSelectRecord(e){
      // uncheck others
      const all = Array.from(document.querySelectorAll('input[name="selectRec"]'));
      all.forEach(inp => { if(inp !== e.target) inp.checked = false; });

      if(!e.target.checked){ selectedIndex = null; detailCard.style.display='none'; return; }
      selectedIndex = Number(e.target.dataset.index);
      showDetailsForIndex(selectedIndex);
    }

    function showDetailsForIndex(idx){
      const rec = db[idx];
      if(!rec){ detailFields.innerHTML = '<div class="no-data">Registro no encontrado (índice inválido).</div>'; detailCard.style.display='block'; return; }

      detailFields.innerHTML = '';
      // fields to display (try multiple name variants)
      const mapping = [
        {label:'Inscripción en SILA', names:['INSCRIPCIÓN EN SILA','Inscripción en SILA','Inscripcion en SILA','Inscripción en SILA']},
        {label:'¿Autoriza a Trabajar?', names:['¿Autoriza a Trabajar?','Autoriza a Trabajar','¿Autoriza a trabajar?']},
        {label:'Tipo de Demanda', names:['Tipo de Demanda','TIPO DE DEMANDA','tipo de demanda']},
        {label:'Observaciones', names:['OBSERVACIONES','Observaciones','Observación','Observaciones']},
        {label:'Documentación', names:['Documentación','DOCUMENTACIÓN','Documentacion']}
      ];

      mapping.forEach(m =>{
        const v = getField(rec, m.names) ?? '';
        const row = document.createElement('div'); row.className='field';
        const lab = document.createElement('div'); lab.className='label'; lab.textContent = m.label + ':';
        const val = document.createElement('div'); val.innerHTML = v ? escapeHtml(String(v)).replace(/\n/g,'<br>') : '<span class="no-data">(sin dato)</span>';
        row.appendChild(lab); row.appendChild(val);
        detailFields.appendChild(row);
      });

      detailCard.style.display='block';
      detailCard.scrollIntoView({behavior:'smooth',block:'center'});
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<"'>]/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m];});
    }

    // Para facilitar pruebas: si quieres precargar búsqueda, puedes poner texto aquí
    // searchInput.value = 'moraleda zafayona';

  </script>
</body>
</html>
