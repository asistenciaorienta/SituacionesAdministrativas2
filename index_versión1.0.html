<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Situaciones Administrativas ‚Äî Buscador</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      /* ---- Reset b√°sico y layout ---- */
      html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#f5f5f5;color:#111}
      .container{max-width:980px;margin:28px auto;padding:20px}
      h1,h2,h3{color:#007A33;margin:0 0 14px 0}
      /* ---- Card ---- */
      .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:20px;margin-bottom:18px}
      /* ---- Botones ---- */
      .btn{background:#007A33;color:#fff;border:0;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:16px}
      .btn:hover{background:#005e29}
      .btn-small{background:#ccc;color:#222;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
      .btn-small:hover{background:#bbb}
      .btn-principal{background:#007A33;color:#fff;font-size:20px;padding:16px 24px;border-radius:10px;width:100%;max-width:520px}
      .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
      .center{text-align:center}
      /* ---- Area inicial ---- */
      #pagina_inicial{padding:30px 20px}
      .botones-nacionalidad{display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:16px}
      .tooltip-container{position:relative;display:inline-block}
      .help-icon{background:#fff;color:#007A33;border-radius:50%;width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;font-weight:bold;border:1px solid #ddd}
      .tooltip-text{visibility:hidden;position:absolute;left:50%;transform:translateX(-50%);top:36px;background:#fff;border:1px solid #ddd;padding:10px;border-radius:8px;max-width:340px;box-shadow:0 6px 18px rgba(0,0,0,0.08);text-align:left;z-index:30}
      .tooltip-container:hover .tooltip-text{visibility:visible}
      /* ---- B√∫squeda ---- */
      .search-container{border-radius:10px;overflow:hidden;background:#fff;box-shadow:0 0 0 2px #007A33;padding:10px}
      textarea#search-box{width:100%;min-height:84px;border:0;padding:10px;border-radius:8px;font-size:15px;resize:vertical;box-sizing:border-box}
      .button-container{margin-top:12px;text-align:center}
      /* ---- Resultados tabla ---- */
      #resultado table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
      #resultado th,#resultado td{padding:10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
      #resultado th{background:#f7f7f7}
      .radio-cell{width:40px;text-align:center}
      .res-row:hover{background:#fbfffb}
      .titulo-principal{font-weight:700;color:#004d2e}
      /* ---- Panel sugerencias (oculto por defecto) ---- */
      .panel-sugerencias{max-height:0;overflow:hidden;transition:max-height .45s ease;background:#f5f5f5;border-radius:12px;padding:0 18px;margin-top:16px}
      .panel-sugerencias.visible{max-height:700px;padding:18px}
      .sugerencias-grid{display:flex;gap:18px;max-width:900px;margin:0 auto;flex-wrap:wrap}
      .columna-izq,.columna-der{flex:1;min-width:220px}
      .sugerencias-grid label{display:block;margin-bottom:8px;cursor:pointer}
      .sugerencias-grid label.disabled{color:#999;cursor:not-allowed}
      /* ---- Detalle final ---- */
      #detalleFinal{display:none;background:#fff;border-radius:10px;padding:16px;margin-top:16px;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
      #detalleFinal table{width:100%;border-collapse:collapse}
      #detalleFinal th{width:220px;text-align:left;padding:8px;vertical-align:top;background:#f6f6f6}
      #detalleFinal td{padding:8px;vertical-align:top}
      /* ---- Modales ---- */
      .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
      .modal-content{background:#fff;padding:18px;border-radius:10px;max-width:480px;box-shadow:0 6px 20px rgba(0,0,0,0.12);text-align:center}
      .hidden{display:none}
      /* ---- Footer info ---- */
      footer{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:14px 0;font-size:13px;color:#007A33}
      footer img{height:60px}
      /* Responsivo */
      @media (max-width:720px){.columna-izq,.columna-der{min-width:100%}.btn-principal{font-size:18px}}
    </style>
  </head>
  <body>
    <div class="container">
      <header class="card center" id="pagina_inicial">
        <h1>Ayuda para el registro en SILA de una persona extranjera</h1>
        <p style="max-width:720px;margin:10px auto 0">Selecciona el origen de la persona usuaria y contin√∫a el flujo. Esta herramienta usa el fichero <code>SituacionesAdministrativas.json</code> (misma carpeta).</p>

        <div class="card" style="margin-top:18px">
          <h2>Selecciona el origen</h2>
          <div class="botones-nacionalidad">
            <div style="display:flex;gap:10px;align-items:center;justify-content:center">
              <button class="btn-secundario btn-small" onclick="mostrarFormularioComunitario()">Comunitario/a</button>
              <div class="tooltip-container" aria-hidden="true">
                <span class="help-icon">?</span>
                <div class="tooltip-text">
                  <strong>Pa√≠ses comunitarios:</strong><br>
                  Austria, B√©lgica, Bulgaria, Chipre, Rep√∫blica Checa, Dinamarca, Estonia, Finlandia, Francia,
                  Alemania, Grecia, Hungr√≠a, Irlanda, Italia, Letonia, Lituania, Luxemburgo, Malta,
                  Pa√≠ses Bajos, Polonia, Portugal, Ruman√≠a, Eslovaquia, Eslovenia, Espa√±a, Suecia,
                  Islandia, Liechtenstein, Noruega, Suiza.
                </div>
              </div>
            </div>

            <button class="btn-principal" onclick="mostrarFormularioNoComunitario()">No Comunitario/a</button>
          </div>
        </div>
      </header>

      <!-- Documentaci√≥n Comunitario -->
      <section id="Doc_Necesaria_Comunitario" class="card hidden" aria-hidden="true">
        <h2>Documentaci√≥n necesaria - Comunitario/a</h2>
        <p>Documento acreditativo de identidad, certificado de inscripci√≥n, tarjeta verde, etc.</p>
        <div style="text-align:center;margin-top:12px">
          <button class="btn-small" onclick="volverNacionalidad()">‚Üê Volver</button>
        </div>
      </section>

      <!-- Formulario / Buscador -->
      <section id="formulario" class="card hidden" aria-hidden="true">
        <h2>B√∫squeda en Situaciones Administrativas</h2>

        <div class="search-container" role="search">
          <textarea id="search-box" placeholder="Copia aqu√≠ los conceptos clave..." onfocus="preguntarBorrado(event)"></textarea>
        </div>

        <div class="button-container">
          <button id="buscarBtn" class="btn" title="Buscar">Buscar</button>
          <button class="btn-small" onclick="confirmarBorrado()">Borrar b√∫squeda</button>
        </div>

        <div id="loader" style="display:none;text-align:center;margin-top:10px">üîÑ Buscando...</div>

        <div id="resultado" class="hidden" aria-live="polite" style="margin-top:12px"></div>

        <!-- Panel Sugerencias (ABAJO) -->
        <div id="sugerenciasPanel" class="panel-sugerencias" aria-hidden="true">
          <h3 style="text-align:center">Selecciona uno o m√°s conceptos clave</h3>
          <form id="sugerenciasForm" class="sugerencias-grid" aria-label="Sugerencias"></form>
          <div style="text-align:center;margin-top:12px">
            <button class="btn" onclick="buscarDesdeSugerencias()">Buscar con selecci√≥n</button>
            <button class="btn-small" onclick="ocultarSugerencias()">‚Üê Ocultar</button>
          </div>
        </div>

        <div style="text-align:center;margin-top:14px">
          <button class="btn-small" onclick="volverInicioDesdeFormulario()">‚Üê Volver</button>
        </div>

        <!-- Detalle final (al seleccionar un registro) -->
        <div id="detalleFinal" aria-hidden="true">
          <h3>Ficha del registro seleccionado</h3>
          <div id="fichaTitulo" style="margin-bottom:10px;font-weight:700;color:#004d2e"></div>
          <table id="tablaFinal"></table>
          <div style="text-align:center;margin-top:12px">
            <button class="btn-small" onclick="volverBuscar()">‚Üê Volver a resultados</button>
          </div>
        </div>
      </section>

      <!-- Modal borrar (confirma limpiar) -->
      <div id="modal-borrar" class="modal hidden" aria-hidden="true">
        <div class="modal-content">
          <p>¬øDeseas borrar el contenido actual?</p>
          <div style="margin-top:12px;display:flex;gap:12px;justify-content:center">
            <button class="btn" onclick="limpiarBusquedaConfirmada()">S√≠, borrar</button>
            <button class="btn-small" onclick="cerrarModalBorrar()">No, modificar</button>
          </div>
        </div>
      </div>

      <!-- Modal Inscrito (SI / NO) -->
      <div id="modalInscrito" class="modal hidden" aria-hidden="true">
        <div class="modal-content">
          <h3>Tras consultar SILA<br>¬øest√° actualmente inscrita esta persona?</h3>
          <div style="margin-top:12px;display:flex;gap:12px;flex-direction:column">
            <button class="btn" onclick="guardarEstado('SI')">S√≠</button>
            <button class="btn" onclick="guardarEstado('NO')">No</button>
            <button class="btn-small" onclick="cerrarModalInscrito()">Cancelar</button>
          </div>
        </div>
      </div>

      <footer>
        <div style="display:flex;align-items:center;gap:10px">
          <strong>Direcci√≥n Provincial de Granada</strong>
          <img src="/SituacionesAdministrativas/images/SAE_Junta_de_Andalucia_Documentacion.png" alt="Logo Junta" />
        </div>
        <div style="text-align:right">
          <strong>Soporte testeo</strong><br>
          Versi√≥n 4.0 ‚Äî Elisabeth Huertas &amp; Jos√© Manuel Robles
        </div>
      </footer>
    </div>

    <script>
      /* ==========================
         Variables globales y configuraci√≥n
         ========================== */
      const JSON_PATH = './SituacionesAdministrativas.json'; // mismo directorio
      let estadoInscrito = ""; // 'SI', 'NO' o "" (vac√≠o)
      let registros = [];       // contenido del JSON
      let ultimosResultados = []; // resultados actuales (array)
      const conceptosClave = [
        "Art 50 TUE. Retirada Reino Unido",
        "Asilo / Ap√°trida / Desplazados o protecci√≥n internacional",
        "Circunstancias excepcionales",
        "Estudio, pr√°cticas o voluntariado",
        "Familiar de ciudadano de UE",
        "Ley 14/2013",
        "Menores",
        "Reagrupaci√≥n familiar",
        "Residencia temporal que Autoriza a trabajar",
        "Residencia temporal que No Autoriza a trabajar",
        "Residencia Larga Duraci√≥n",
        "Permiso de Residencia y Trabajo",
        "Visado b√∫squeda empleo",
        "Prestaci√≥n sin autorizaci√≥n laboral"
      ];
      const combinacionesValidas = [
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia temporal que Autoriza a trabajar"],
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia temporal que No Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que No Autoriza a trabajar"],
        ["Residencia Larga Duraci√≥n", "Permiso de Residencia y Trabajo"],
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia Larga Duraci√≥n", "Permiso de Residencia y Trabajo"]
      ];

      /* ==========================
         Utilidades: mostrar/ocultar
         ========================== */
      const $ = id => document.getElementById(id);
      function show(el){ if(el) el.classList.remove('hidden'); }
      function hide(el){ if(el) el.classList.add('hidden'); }

      /* ==========================
         Carga inicial: JSON y eventos
         ========================== */
      document.addEventListener('DOMContentLoaded', () => {
        // cargar datos JSON
        fetch(JSON_PATH)
          .then(r => {
            if(!r.ok) throw new Error('No se pudo cargar el JSON: ' + r.status);
            return r.json();
          })
          .then(data => {
            registros = Array.isArray(data) ? data : [];
          })
          .catch(err => {
            console.error(err);
            mostrarModalSimple('No se pudo leer SituacionesAdministrativas.json. Comprueba que est√° en la misma carpeta.');
          });

        // eventos
        $('buscarBtn').addEventListener('click', () => { ocultar_resultado(); buscar(); });
      });

      /* ==========================
         UI: navegaci√≥n entre pantallas
         ========================== */
      function mostrarFormularioComunitario(){
        hide($('pagina_inicial'));
        show($('Doc_Necesaria_Comunitario'));
      }
      function mostrarFormularioNoComunitario(){
        // abrir modal inscripci√≥n (SI/NO)
        show($('modalInscrito'));
      }
      function cerrarModalInscrito(){ hide($('modalInscrito')); }
      function guardarEstado(valor){
        estadoInscrito = (valor||'').toString().toUpperCase();
        hide($('modalInscrito'));
        mostrarFormularioBusqueda();
      }
      function mostrarFormularioBusqueda(){
        hide($('pagina_inicial'));
        hide($('Doc_Necesaria_Comunitario'));
        show($('formulario'));
        // al abrir buscador, ocultar panel sugerencias y detalle
        hide($('sugerenciasPanel'));
        hide($('detalleFinal'));
        $('search-box').focus();
      }
      function volverNacionalidad(){
        hide($('Doc_Necesaria_Comunitario'));
        hide($('formulario'));
        show($('pagina_inicial'));
      }
      function volverInicioDesdeFormulario(){
        limpiarChecksSugerencias();
        hide($('formulario'));
        show($('pagina_inicial'));
      }

      /* ==========================
         Borrar / limpiar b√∫squedas
         ========================== */
      function preguntarBorrado(evt){
        const ta = $('search-box');
        if(ta && ta.value.trim() !== ''){
          // abrir modal borrar (confirmaci√≥n)
          show($('modal-borrar'));
        }
      }
      function cerrarModalBorrar(){ hide($('modal-borrar')); $('search-box').focus(); }
      function confirmarBorrado(){
        // atajos: eliminar texto y ocultar resultados
        $('search-box').value = '';
        limpiarBusquedaConfirmada();
      }
      function limpiarBusquedaConfirmada(){
        // limpia caja de b√∫squeda, oculta resultados/sugerencias y limpia checks
        $('search-box').value = '';
        hide($('resultado'));
        hide($('sugerenciasPanel'));
        limpiarChecksSugerencias();
        cerrarModalBorrar();
      }

      /* ==========================
         Sugerencias: render, l√≥gica combinatoria
         ========================== */
      function mostrarSugerencias(){
        const panel = $('sugerenciasPanel');
        const form = $('sugerenciasForm');
        // render
        const primera = conceptosClave.slice(0,7);
        const segunda = conceptosClave.slice(7);
        const col1 = primera.map(c => `<label><input type="checkbox" value="${escapeHtml(c)}"> ${escapeHtml(c)}</label>`).join('');
        const col2 = segunda.map(c => `<label><input type="checkbox" value="${escapeHtml(c)}"> ${escapeHtml(c)}</label>`).join('');
        form.innerHTML = `<div class="columna-izq">${col1}</div><div class="columna-der">${col2}</div>`;
        anadirEventosCheck();
        actualizarDisponibles();
        // abrir panel
        panel.classList.add('visible');
        panel.classList.remove('hidden');
        panel.setAttribute('aria-hidden','false');
      }

      function ocultarSugerencias(){
        const panel = $('sugerenciasPanel');
        panel.classList.remove('visible');
        setTimeout(()=>{ panel.classList.add('hidden'); panel.setAttribute('aria-hidden','true'); }, 450);
      }

      function anadirEventosCheck(){
        const checks = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]');
        checks.forEach(cb => cb.addEventListener('change', actualizarDisponibles));
      }

      function actualizarDisponibles(){
        const checkboxes = Array.from(document.querySelectorAll('#sugerenciasForm input[type="checkbox"]'));
        const labels = Array.from(document.querySelectorAll('#sugerenciasForm label'));
        const seleccionados = checkboxes.filter(cb => cb.checked).map(cb => cb.value);
        if(seleccionados.length === 0){
          checkboxes.forEach(cb => cb.disabled = false);
          labels.forEach(l => l.classList.remove('disabled'));
          return;
        }
        function esCompatible(candidato){
          return combinacionesValidas.some(comb => {
            if(!comb.includes(candidato)) return false;
            return seleccionados.every(sel => comb.includes(sel));
          });
        }
        checkboxes.forEach(cb => {
          const label = cb.closest('label');
          if(seleccionados.includes(cb.value)){
            cb.disabled = false;
            label && label.classList.remove('disabled');
          } else {
            if(esCompatible(cb.value)){
              cb.disabled = false;
              label && label.classList.remove('disabled');
            } else {
              cb.disabled = true;
              label && label.classList.add('disabled');
            }
          }
        });
      }

      function limpiarChecksSugerencias(){
        const all = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]');
        all.forEach(c => c.checked = false);
        // quitar clases disabled si las hubiera
        const labels = document.querySelectorAll('#sugerenciasForm label');
        labels.forEach(l => l.classList.remove('disabled'));
      }

      /* ==========================
         Buscar: l√≥gica principal (ANVERSO + REVERSO + OBSERVACIONES)
         ========================== */
      function escapeHtml(str){
        return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      async function buscar(palabrasDesdeSugerencias = null){
        const textoRaw = (palabrasDesdeSugerencias && palabrasDesdeSugerencias.length>0)
          ? palabrasDesdeSugerencias.join(' ')
          : document.getElementById('search-box').value.trim();

        const texto = (textoRaw || '').toUpperCase().trim();
        if(!texto){
          mostrarModalSimple('Por favor, introduce un texto para buscar o usa las sugerencias.');
          return;
        }

        // preparar array de palabras (AND)
        const palabras = texto.split(/\s+/).filter(Boolean).map(p => p.replace(/[^\w√Ä-√ø-]/g,'').toUpperCase());

        $('loader').style.display='block';
        hide($('resultado'));
        hide($('detalleFinal'));

        // filtrar registros en memoria (registros)
        const resultados = registros.filter(reg=>{
          // 1) filtro por '¬øInscrito anteriormente?' seg√∫n estadoInscrito
          const campoInscrito = ((reg["¬øInscrito anteriormente?"]||'') + '').trim().toUpperCase();
          if(campoInscrito === 'SI' && estadoInscrito !== 'SI') return false;
          if(campoInscrito === 'NO' && estadoInscrito !== 'NO') return false;
          // 2) comprobaci√≥n de palabras en ANVERSO, REVERSO, OBSERVACIONES
          const anverso = (reg.ANVERSO || '').toString().toUpperCase();
          const reverso = (reg.REVERSO || '').toString().toUpperCase();
          const obs = (reg.OBSERVACIONES || reg.Observaciones || '').toString().toUpperCase();
          return palabras.every(p => (anverso.includes(p) || reverso.includes(p) || obs.includes(p)));
        });

        ultimosResultados = resultados; // guardar
        renderResultados(resultados);

        // reglas: si no hay resultados ‚Üí mostrar sugerencias
        if(resultados.length === 0){
          // mostrar panel sugerencias
          showSugerenciasPanel();
        } else {
          hideSugerenciasPanel();
        }

        $('loader').style.display='none';
      }

      function showSugerenciasPanel(){
        // render and show panel
        mostrarSugerencias();
      }
      function hideSugerenciasPanel(){
        hide($('sugerenciasPanel'));
        $('sugerenciasPanel').classList.remove('visible');
        limpiarChecksSugerencias();
      }

      /* ==========================
         Render tabla de resultados
         ========================== */
      function renderResultados(data){
        const cont = $('resultado');
        cont.innerHTML = ''; // limpiar
        if(!data || data.length === 0){
          cont.innerHTML = `<p style="text-align:center;margin:12px 0">No se encontr√≥ nada. Prueba con otras palabras o usa <button class="btn-small" onclick="mostrarSugerencias()">Mostrar sugerencias</button>.</p>`;
          show(cont);
          return;
        }

        // crear tabla con la cabecera solicitada
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th class="radio-cell"></th>
              <th>ANVERSO ‚Äì REVERSO</th>
              <th>INSCRIPCI√ìN EN SILA</th>
              <th>¬øAutoriza a Trabajar?</th>
              <th>Tipo de Demanda</th>
              <th>OBSERVACIONES</th>
              <th>Documentaci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        data.forEach((item, idx) => {
          const titleLine = `${escapeHtml(item.ANVERSO || '')} ‚Äî ${escapeHtml(item.REVERSO || '')}`;
          const fila = document.createElement('tr');
          fila.className = 'res-row';
          fila.innerHTML = `
            <td class="radio-cell">
              <input type="radio" name="seleccion" id="sel_${idx}" data-index="${idx}">
            </td>
            <td><div class="titulo-principal">${titleLine}</div></td>
            <td>${escapeHtml(item["INSCRIPCI√ìN EN SILA"] || item["Inscripci√≥n en SILA"] || '')}</td>
            <td>${escapeHtml(item["¬øAutoriza a Trabajar?"] || item["Autoriza"] || '')}</td>
            <td>${escapeHtml(item["Tipo de Demanda"] || '')}</td>
            <td>${escapeHtml(item["OBSERVACIONES"] || item["Observaciones"] || '')}</td>
            <td>${formatDocumentoCell(item["Documentaci√≥n"] || item["documentaci√≥n"] || '')}</td>
          `;
          tbody.appendChild(fila);

          // evento selecci√≥n
          const radio = fila.querySelector('input[type="radio"]');
          radio.addEventListener('change', () => {
            mostrarRegistroFinal(item, titleLine);
          });
        });

        cont.appendChild(table);
        show(cont);
      }

      function formatDocumentoCell(valor){
        if(!valor) return 'No disponible';
        // si es URL simple, mostrar enlace; si contiene texto largo, mostrarlo truncado
        const s = (valor||'').toString();
        if(s.startsWith('http') || s.endsWith('.pdf')) return `<a href="${s}" target="_blank" rel="noopener noreferrer">Ver PDF</a>`;
        return escapeHtml(s);
      }

      /* ==========================
         Al seleccionar un resultado -> mostrar ficha completa
         ========================== */
      function mostrarRegistroFinal(reg, titulo){
        // rellenar ficha
        $('fichaTitulo').innerHTML = titulo || (escapeHtml(reg.ANVERSO||'') + ' ‚Äî ' + escapeHtml(reg.REVERSO||''));
        const campos = [
          {k: 'INSCRIPCI√ìN EN SILA', label: 'Inscripci√≥n en SILA'},
          {k: '¬øAutoriza a Trabajar?', label: '¬øAutoriza a Trabajar?'},
          {k: 'Tipo de Demanda', label: 'Tipo de Demanda'},
          {k: 'OBSERVACIONES', label: 'Observaciones'},
          {k: 'Documentaci√≥n', label: 'Documentaci√≥n'}
        ];

        let html = '';
        campos.forEach(c => {
          const valor = reg[c.k] || reg[c.k.toLowerCase()] || reg[c.k.charAt(0)+c.k.slice(1).toLowerCase()] || '';
          const v = (c.label === 'Documentaci√≥n') ? formatDocumentoCell(valor) : escapeHtml(valor);
          html += `<tr><th>${escapeHtml(c.label)}</th><td>${v}</td></tr>`;
        });

        $('tablaFinal').innerHTML = html;
        // mostrar detalle
        show($('detalleFinal'));
        $('detalleFinal').setAttribute('aria-hidden','false');
        // opcional: ocultar resultados para foco en ficha (si prefieres mantener tabla visible, comenta la siguiente l√≠nea)
        hide($('resultado'));
        // siempre ocultar panel sugerencias
        hideSugerenciasPanel();
        // scroll a detalle
        setTimeout(()=> { document.getElementById('detalleFinal').scrollIntoView({behavior:'smooth'}); }, 80);
      }

      function volverBuscar(){
        hide($('detalleFinal'));
        show($('resultado'));
        $('resultado').scrollIntoView({behavior:'smooth'});
      }

      /* ==========================
         Buscar desde Sugerencias
         ========================== */
      function buscarDesdeSugerencias(){
        const checks = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]:checked');
        const seleccionados = Array.from(checks).map(cb => cb.value);
        if(seleccionados.length === 0){
          alert('Debes seleccionar al menos un concepto.');
          return;
        }
        // l√≥gica de combinaciones: si 1 => se usa esa; si varias => buscar combinaci√≥n v√°lida
        let conceptoBusqueda = null;
        if(seleccionados.length === 1) conceptoBusqueda = seleccionados[0];
        else {
          for(const comb of combinacionesValidas){
            const esSub = seleccionados.every(s => comb.includes(s));
            if(esSub){ conceptoBusqueda = comb[0]; break; }
          }
          if(!conceptoBusqueda){
            alert('La combinaci√≥n seleccionada no es v√°lida.');
            return;
          }
        }
        // lanzar b√∫squeda con palabras (convertir en array de palabras)
        const palabras = conceptoBusqueda.toUpperCase().split(/\s+/).filter(Boolean);
        buscar(palabras);

        // ocultar panel y limpiar checks
        hideSugerenciasPanel();
        limpiarChecksSugerencias();
      }

      /* ==========================
         Helpers UI modal simple
         ========================== */
      function mostrarModalSimple(texto){
        // usa modal-borrar temporalmente para mostrar texto simple
        // creamos un modal peque√±o temporal
        const tmp = document.createElement('div');
        tmp.className = 'modal';
        tmp.innerHTML = `<div class="modal-content"><p>${escapeHtml(texto)}</p><div style="margin-top:12px"><button class="btn" id="tmpCerrar">Cerrar</button></div></div>`;
        document.body.appendChild(tmp);
        document.getElementById('tmpCerrar').addEventListener('click', ()=> { tmp.remove(); });
      }

      /* ==========================
         Peque√±as utilidades adicionales
         ========================== */
      function ocultar_resultado(){ hide($('resultado')); }
      // limpiar checks al volver a inicio (bot√≥n)
      // Tambi√©n se ha integrado en volverInicioDesdeFormulario

      // proteger contra errores de elementos inexistentes al usar show/hide
      function hideSugerenciasPanel(){ hide($('sugerenciasPanel')); $('sugerenciasPanel').classList.remove('visible'); $('sugerenciasPanel').setAttribute('aria-hidden','true'); }
      function limpiarChecksSugerenciasOnExit(){
        limpiarChecksSugerencias();
        hideSugerenciasPanel();
      }

      // cerrar modal borrar (NO borrar)
      function cerrarModalBorrar(){ hide($('modal-borrar')); }
    </script>
  </body>
</html>

